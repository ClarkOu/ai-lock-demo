# AI 助手 for 酒店门锁系统 — v1.1 进阶版 PRD（单店离线优化版）

版本：v1.1（过程稿）  
日期：2025-11-20  
说明：基于 v1.0 评审反馈优化。核心调整方向为：**单店离线场景适配、降低用户维护成本、强化“垂直专家”属性、明确工程落地约束**。

## 变更摘要
1.  **移除原 3xx（知识库管理）**：改为出厂内置产品手册，用户无需维护。
2.  **移除原 5xx（自助报表）**：移除复杂构建器，用 AI 对话查询代替。
3.  **重构原 6xx（订阅）**：改为“每日简报”主动弹窗，更适合单店管理习惯。
4.  **新增 [208] 一键巡检**：强化 AI 的主动诊断能力。
5.  **新增 [604] 工程约束**：明确本地部署的硬件、模型选型与交付标准。
6.  **固化 7xx（集成）**：明确为预置集成，无需用户配置。
7.  **全局重编号**：移除废弃模块后，对章节序号进行了重新编排（3xx~7xx）。

## 模块索引
- 1xx 全局与入口
- 2xx 对话与问答（Chat/RAG）
- 3xx 预置报表（精简版）
- 4xx 导出与每日简报
- 5xx 权限与租户隔离
- 6xx 模型安全、配置与工程约束
- 7xx 数据接入与集成（预置）

---

## 1xx 全局与入口

[101] 全局入口与会话入口
- 用户故事：作为任一登录用户，我希望随时打开 AI 助手发起对话，并在每天首次登录时看到关键信息摘要。
- 功能点说明：
  - 入口形态与位置：
    - 在现有门锁系统所有业务页面右下角常驻一个 AI 助手入口图标（悬浮按钮），不遮挡关键操作区域。
    - **告警弹窗植入**：在系统原生的告警详情弹窗中，预留“AI Analysis”区域，用于展示被动触发的诊断结果（见 [209]）。
    - 悬浮按钮点击后展开主会话面板（侧边抽屉或弹窗），再次点击可最小化回到按钮形态。
    - 支持拖动调整入口按钮位置（仅在当前浏览器会话内生效，不做跨设备持久化）。
  - **每日简报弹窗（新增）**：
    - 逻辑：用户每天（或每班次）首次登录系统时，自动在右下角弹出“每日运营简报”卡片（详见 402）。
    - 交互：点击卡片可展开详情或进入 AI 对话，点击关闭则收起。
  - 打开方式与快捷键：
    - 点击入口按钮可打开/关闭会话面板；
    - 支持快捷键：Mac 为 `Cmd+J`，Windows 为 `Ctrl+J`（如不冲突），按下时：
      - 若当前未打开会话面板，则打开并自动聚焦输入框；
      - 若已打开，则关闭面板。
  - 会话管理：
    - 会话列表默认展示最近 20 个会话，按最近活动时间倒序排列；
    - 支持会话搜索（按会话标题和最近若干条问题文本关键词匹配）；
    - 支持会话置顶（最多置顶 10 个），置顶会出现在列表顶部；
    - 支持重命名会话标题（默认标题为“来自第一个问题的前若干个字”）；
    - 支持归档会话：归档后不再出现在默认列表，只在“已归档”视图中可见。
    - 系统最多保留最近 200 条活动会话（含归档）；超出时按“最早未置顶会话”原则自动清理，清理前给出提示。
  - 数据范围自动生效：
    - 打开会话时，根据当前登录用户的租户/门店权限自动设置数据上下文（例如“X 酒店-杭州店”）；
    - 会话标题区域以标签形式展示当前数据范围；当用户在门锁系统中切换门店时，新发起的会话使用新的范围，但旧会话保留创建时范围记录（只用于审计，不改变权限）。
- 验收标准：入口可达率 100%；会话基本操作成功率 ≥ 99.9%。

[102] 时间与时区一致性
- 用户故事：作为区域经理，我希望跨门店统计在各自本地时区准确聚合。
- 功能点说明：
  - 统一 UTC 存储
  - 按 `property.timezone` 转换展示
  - 跨日界与夏令时正确分段
  - 支持自然语言时间查询（如“上周一到周日”）
- 验收标准：与对账报表误差 < 0.5%；随机抽样 50 条跨日界场景均正确。

---

## 2xx 对话与问答（Chat/RAG）

说明：本模块默认支持英文（English）交互，针对国际连锁场景，SOP 检索与回答优先使用英文内容。

[201] 会话创建与上下文管理
- 用户故事：作为用户，我希望可以快速开启对话，历史记录自动保留但不会干扰新问题，以便我高效完成单次任务。
- 功能点说明：
  - 新建会话：
    - 用户点击 AI 入口按钮时，直接进入对话界面；
    - 若距上次对话不超过 10 分钟，延续上下文；否则视为新会话；
    - 用户可点击输入框上方的"开启新对话"按钮，主动断开上下文。
  - 自动断开与分段：
    - 当用户超过 10 分钟无交互后，当前会话自动结束；
    - 下次提问时，对话区域显示分隔符"── 以下为新会话 · HH:MM ──"；
    - 新对话不关联之前的上下文，但历史记录仍可向上滚动查看。
  - 历史记录：
    - 对话历史按时间倒序保留，最多保留最近 30 天或 200 条消息；
    - 不同会话之间以分隔符区分；
    - 超出保留期限的历史自动清理。
  - 上下文窗口与自动摘要：
    - 系统在构造 Prompt 时携带当前会话的历史消息；
    - 若总 Token 超过模型上下文限制，调用摘要模型压缩早期对话（具体模型待开发过程中调试）；
    - 摘要内容对用户不可见，包含：用户意图、关键约束、已确认结论、涉及的数据范围等；
    - 若摘要失败（模型调用异常等），当前窗口仍可继续对话，需记录日志以便后续排查。
- 验收标准：会话自动断开机制准确触发；摘要不改变事实；历史记录加载成功率 ≥ 99%。

[202] 意图识别与分流
- 用户故事：作为用户，我提问后系统能识别 FAQ/SOP/数据查询/报表生成并走合适流程。
- 功能点说明：
  - 意图类别：至少支持以下一级意图：
    - FAQ/规则类：适合直接从知识库中检索标准答案（例如“入住时间规定是什么？”、“如何重置门锁？”）；
    - 操作指南/SOP 类：需要从 SOP 文档中抽取步骤或流程（例如“更换电池的步骤是什么？”）；
    - 数据查询/临时报表类：需要访问事件/设备等数据源并返回表格或图表（例如“最近7天门店A的开门失败率趋势”）；
    - 预置报表跳转类：用户提到具体报表名或典型描述（例如“打开开门成功率报表”、“看一下门店对比排行榜”）；
    - **系统诊断类（新增）**：用户询问系统健康状况或请求检查（例如“系统正常吗”、“检查一下设备”）。
    - 闲聊/非业务类：系统可以简单响应或引导用户回到业务问题。
  - 分类器输出：
    - 对每条用户消息，意图识别模块输出：`intent_type`、`sub_type`（可选）、`confidence`（0~1）、解析的结构化信息（如时间、对象等）；
    - 当 `confidence` 高于配置阈值（例如 0.7）时，直接按识别结果进行分流；
    - 当 `confidence` 低于阈值时：
      - 系统不直接调用工具，而是向用户发出澄清提问（例如“你是想查询数据，还是查看操作指引？”）；
      - 若用户仍未给出清晰选择，则走保守路径（一般优先 FAQ/RAG，避免误触发数据写操作——1.0 暂无写操作）。
  - 分流逻辑：
    - **FAQ/SOP 类**：走知识检索流程（见 203），检索**系统内置产品手册**。
    - 数据查询/临时报表类：走 204 所述的“意图→结构化查询”流程，并返回结果卡片；
    - 预置报表跳转类：直接构造对应报表的默认参数（如最近 7 天、当前门店），并跳转至对应报表页面或返回报表卡片（3xx 模块）；
    - **系统诊断类**：触发一键巡检流程（见 208）。
    - 闲聊类：调用通用对话模型，同时限制回答不触及隐私/合规红线。
  - 可配置项：
    - 支持在后台配置意图阈值、启用/禁用某些意图类型（例如在某租户禁用“闲聊”）；
    - 支持对某些关键句型做规则兜底（如“生成 XX 报表”直接映射到指定报表）。
- 验收标准：意图识别准确率（人工评测）≥ 90%。

[203] RAG 检索（基于内置手册）
- 用户故事：作为用户，我希望快速获取准确的产品使用说明和故障排查指南，而无需翻阅纸质文档。
- 功能点说明：
  - **内置知识库**：
    - 系统出厂预装主流门锁型号的说明书、安装指南、故障代码表、维修 SOP。
    - 该知识库对用户不可见（无管理界面），仅支持管理员在后台通过补丁包更新。
  - 检索流程：
    - 用户提问 -> 向量检索内置手册 -> 生成答案。
    - 引用标注：显示“来源：系统内置手册 - 《XX型号维修指南》”。
  - 无命中与兜底：
    - 当所有结果相似度低于阈值时：
      - 不生成具体回答内容，而是返回“未检索到可靠依据”的提示；
      - 同时列出若干相近的知识库文档标题或常见问题作为建议链接；
      - 提示用户可以提供更具体的关键词或截图。
- 验收标准：常见故障代码查询命中率 100%；引用来源准确。

[204] 数据查询意图转结构化查询
- 用户故事：作为运维，我用自然语言描述条件，系统生成表格结果。
- 功能点说明：
  - 入口形式：
    - 用户在对话框中输入自然语言问题，例如：“近30天开门失败率>3%的门店有哪些？”、“列出本周低电池告警次数最多的前10个设备”。
    - 系统在后台对每条消息先做意图分类：若判定为“数据查询/报表类意图”，则进入本功能流程。
  - 解析内容（意图 → 结构化查询对象）：
    - 时间范围：
      - 支持绝对时间（“2025-01-01 至 2025-01-31”）与相对时间（“最近7天”、“上周”、“本月”）。
      - 未明确时间时，默认时间范围为最近 7 天，并在结果上方显式展示默认范围。
    - 维度：
      - 从语句中识别出分组维度（如门店、房间、设备型号、小时、星期几等），映射到 `DataModel.md` 中对应字段（如 `property_id`、`room_id`、`device.model`、本地小时等）。
      - **新增关联维度**：支持关联房态信息（如“有客房”、“空房”）和入住信息（如“即将离店”、“已延住”），用于业务层面的筛选。
      - 若用户未指定维度但语义明显需要（例如“排名前10个门店”），系统自动选择合适的维度（如门店）。
    - 指标：
      - 识别常见指标词：失败率、成功率、次数、告警数、设备数、占比等，并映射到 `ReportingSpecs.md` 中既定公式。
      - 一个查询中可包含 1~3 个指标（例如：开门失败率、开门尝试次数、失败次数）。
    - 过滤条件：
      - 从语义中抽取条件：门店范围、楼层、房型、设备型号、事件类型、卡类型、来源（card/mobile/staff）、原因码等。
      - 支持简单比较：`>`、`<`、`>=`、`<=`、`=`（例如“失败率>3%”、“超过 50 次告警”）。
    - 排序与限制：
      - 默认按主要指标降序排列（如“失败率最高的门店”）。
      - 支持 TopN 语义（“前10”、“Top 5”），N 最大不超过 100。
  - 统一查询模型与校验：
    - 将上述解析结果构造成内部“查询描述对象”（Query DTO），包含：time_range、dimensions[]、metrics[]、filters[]、sort_by、limit 等字段。
    - 在进入数据服务前进行严格校验：
      - 所有字段必须来自白名单（避免任意 SQL 字段注入）。
      - 所有操作符在允许列表中（例如只允许 `=, >, <, >=, <=, in`）。
      - 对于率类指标，自动增加必要的过滤（如只统计 `event_type in ('open','fail')`）。
  - 业务规则与口径：
    - 默认过滤 `device.status in ('active','online')`，除非用户明确要求包含离线/停用设备（此类特殊需求不在 1.0 UI 中暴露，仅通过运营配置）。
    - 分母为 0 时，该行指标返回 NULL（前端显示为 “—”），不报错。
    - 与预置报表（3xx 模块）使用同一套聚合逻辑与代码路径，避免“聊天查出来”和“报表查出来”不一致。
  - 分页与限流：
    - 单次交互默认返回前 100 行数据，最大不超过 5,000 行。
    - 当内部结果集超过 5,000 行时：
      - 对话界面只展示前 100 行；
      - 同时提供“导出全部”入口，引导用户走导出功能（受导出权限与审计控制）。
    - 对同一会话、同一用户，在单位时间内的结构化查询调用设置限流阈值（如每分钟 10 次），超过后返回友好错误提示。
  - 结果展示：
    - 对话中以“结果卡片”的形式展示表格，表头为维度+指标名称，支持横向滚动。
    - 结果卡片顶部展示：自然语言查询摘要、解析出的时间范围与主要过滤条件，便于用户核对。
    - 用户可在卡片上点击“调整条件”进入轻量配置面板（时间/门店/TopN 等），重新发起查询。
- 验收标准：解析成功率 ≥ 90%；对照 SQL 抽检 50 条无口径偏差。

[205] 结构化结果卡片（表格/图表）
- 用户故事：作为经理，我要在对话中直接看到图表并能导出。
- 功能点说明：
  - 卡片类型与触发方式：
    - 当 204 数据查询或 3xx 报表通过对话触发时，系统以“结果卡片”的形式返回，而不是纯文本；
    - 支持的卡片类型包括：表格卡片、折线图卡片、柱状图卡片、饼图/环形图卡片；
    - 具体使用哪种图表类型，可由后端根据查询维度/指标推荐，也可在后续版本提供用户切换能力（1.0 先由系统自动选择）；
  - 卡片内容结构：
    - 标题栏：展示报表名称或根据用户问题生成的摘要标题（例如“近30天门店A开门失败率”）；
    - 条件说明：以一行小字列出关键查询条件（时间范围、门店范围、主要过滤条件），需与实际查询条件保持一致；
    - 主体区域：
      - 表格卡片：
        - 表头为维度列 + 指标列，至少包含维度字段名（如日期、门店）和主要指标（如成功率、次数）；
        - 支持横向滚动查看所有列；
        - 支持点击列头进行升序/降序排序（默认按主要指标降序）。
      - 图表卡片：
        - 折线/柱状：X 轴为时间或分类维度，Y 轴为数值指标；
        - 饼图/环形图：用于展示占比类指标（如各原因占比、各门店占比），限制类目数量（例如最多 10 个，其余归入“其他”）；
        - 鼠标悬停时显示 tooltip（具体值、占比、维度名称）。
    - 解读区域：
      - 在卡片底部提供一段简短的自然语言解读（1~3 句），例如“近7天开门成功率整体稳定在 98% 左右，门店A略低”；
      - 解读文案来源于模型生成，但需控制长度和避免绝对结论。
  - 交互能力：
    - 导出：卡片右上角提供导出按钮，支持导出为 CSV（表格数据）和 PNG（图表截图），具体规范见 401；
    - 复制：提供“复制为表格/Markdown”功能，将当前表格内容和条件说明复制到剪贴板；
    - 重跑：
      - 卡片提供“调整条件后重跑”入口，点击后展开轻量配置面板（如时间范围、TopN、门店选择）；
      - 用户修改参数后再次执行查询，生成新的结果卡片并在会话中追加一条消息；
    - 锚点与折叠：
      - 当同一对话中存在多个结果卡片时，支持折叠/展开卡片，避免占满屏幕；
      - 支持生成卡片的锚点链接，以便用户在长对话中快速跳回该卡片位置。
  - 异常与边界：
    - 数据为空时：
      - 在卡片主体显示“当前条件下无数据”，不展示空白图表；
      - 同时保留条件说明，便于用户修改过滤；
    - 数据量过大时：
      - 表格仅展示前 N 行（如 100 行），并在下方展示“仅显示部分结果，可通过导出查看全部”提示；
    - 当图表无法渲染（前端异常）时，至少保证表格视图可用，或提示用户刷新重试并记录异常日志。
- 验收标准：卡片渲染成功率 ≥ 99%；导出一致性与页面展示一致。

[206] 敏感信息与越权拦截
- 用户故事：作为管理员，我希望越权查询被拦截且提示清晰。
- 功能点说明：
  - 按租户/门店/角色校验；出现跨范围字段或 PII 时脱敏或拒绝。
  - 审计记录包含被拒绝原因（不含原始敏感数据）。
- 验收标准：越权样例 100% 拦截；无 PII 外泄。

[207] 指令模板与快捷提示
- 用户故事：作为新手，我希望快速上手常用问题与报表。
- 功能点说明：
  - 展示位置与数量：
    - 在对话输入框下方或上方区域，展示若干条“指令模板”气泡或按钮；
    - 默认展示 6~10 条模板，保证在常见分辨率下不产生严重换行；
  - 模板内容形式：
    - 模板由“标题 + 示例文案”组成，例如：
      - 标题：“查看开门成功率趋势”；示例文案：“最近7天门店A的开门成功率趋势”；
      - 标题：“查询低电池设备”；示例文案：“列出当前低电池设备列表”；
    - 点击模板时：
      - 将示例文案填充到输入框中，用户可编辑后再发送；
      - 也可提供“直接发送”模式（可配），即点击后立即发送该指令。
  - 动态推荐逻辑：
    - 按角色定制：
      - 运营角色优先展示报表与运营相关模板；
      - 运维角色优先展示告警、设备状态相关模板；
      - 管理角色优先展示汇总类模板（如排行榜、趋势对比）。
    - 按页面/上下文定制：
      - 当用户当前所在页面为“某门店详情”时，模板自动带上该门店作为默认过滤条件；
      - 当用户在某预置报表页面打开 AI 时，模板优先与该报表相关。
  - 配置与管理：
    - 模板集合由后台可配置，包括：标题、示例文案、适用角色、适用页面；
    - 支持启用/禁用某些模板，支持调整排序；
    - 支持按租户自定义模板集合（如大型连锁与单店版区别）。
  - 埋点与效果评估：
    - 对每个模板记录曝光次数、点击次数、点击后发送次数、最终完成查询/报表的次数；
    - 通过这些指标衡量模板效果，为后续优化提供依据。
- 验收标准：模板点击转化率 ≥ 25%；可配置且生效实时。

[208] 一键系统巡检（新增）
- 用户故事：作为店长，我不知道该问什么，但我希望 AI 帮我全面检查一下系统健康状况。
- 功能点说明：
  - 入口：
    - 对话框输入区域上方常驻“系统体检”或“一键巡检”按钮。
  - 执行逻辑：
    - 点击后，AI 自动在后台并行调用一组 MCP 诊断工具：
      1.  **设备在线率检查**：扫描所有设备，统计离线比例。
      2.  **电量健康检查**：统计低电量设备数。
      3.  **异常事件扫描**：检查过去 24 小时是否有未处理的暴力开门/超时告警。
      4.  **时钟同步检查**：检查门锁时钟与系统时间偏差。
  - 输出结果：
    - 生成一份“体检报告卡片”：
      - **健康评分**：基于上述指标计算（如 95 分）。
      - **问题清单**：列出发现的异常点（如“发现 3 个设备电量低于 15%”）。
      - **行动建议**：针对每个问题提供操作按钮（如“查看低电设备”、“查看告警详情”）。
- 验收标准：巡检全流程耗时 < 10s；评分逻辑自洽。

[209] 智能告警分析 (Alert Copilot)
- 用户故事：作为前台，当系统弹出告警时，我希望直接看到 AI 结合房态给出的原因分析和处理建议（SOP），而不是只看到错误代码。
- 功能点说明：
  - **被动触发与嵌入**：
    - AI 模块作为“插件”嵌入到门锁系统的原生告警弹窗中；
    - 当系统触发高危告警（如“非法开门”、“连续刷卡失败”）时，自动调用 AI 进行异步分析。
  - **业务感知诊断 (Context-Aware)**：
    - AI 不仅读取告警错误码，还会自动调用 MCP 工具查询**当前房态**和**卡片信息**；
    - 示例逻辑：收到“刷卡失败”告警 -> 查房态发现“该房间有入住” -> 查卡片发现“有效期截止 12:00” -> 当前时间 13:00 -> **结论：“客人延住未续卡 (Guest extended stay but key not updated)”**。
  - **输出内容**：
    - **原因摘要**：用自然语言（英文优先）解释技术错误码背后的业务原因。
    - **行动建议 (SOP)**：直接展示处理步骤（如“1. Extend stay in PMS; 2. Update key card”）。
- 验收标准：对于常见刷卡失败场景，能准确区分“设备故障”与“业务过期”；分析结果在告警弹窗弹出后 2s 内加载完成。

---

## 3xx 预置报表（3 个）
注：此为面向单店离线场景的简化版报表集。指标与公式详见 `docs/ReportingSpecs.md`。

[301] 运营健康概览
- 用户故事：作为店长，我希望在一个屏幕内快速了解门店运营的核心健康状况，包括客流、服务效率和异常情况。
- 功能点说明：
  - 报表形式：仪表盘（Dashboard）
  - 核心指标卡片（KPI Cards）：
    - **今日总通行人次**：今日内所有成功的开门事件去重后的人数（基于卡 ID 或其他身份标识）。
    - **开门成功率（近24小时）**：`成功开门次数 / (成功开门次数 + 失败开门次数)`，滚动24小时计算。
    - **低电量设备数**：当前电池电量低于 20% 的设备总数。
    - **离线设备数**：当前与系统失联超过 1 小时的设备总数。
    - **异常开门告警（今日）**：今日内发生的“强制开门”、“超时未关”等高风险事件计数。
  - 图表组件：
    - **开门成功率趋势（近7天）**：
      - 类型：折线图
      - X轴：日期
      - Y轴：每日开门成功率（%）
    - **通行人次时段分布（今日）**：
      - 类型：柱状图
      - X轴：小时（0-23）
      - Y轴：通行人次
  - 交互：
    - 默认展示近7天数据，支持按“今日”、“近30天”切换。
    - 点击任一KPI卡片可钻取到对应的详细报表（[302]或[303]）。
- 验收标准：仪表盘数据刷新延迟不超过5分钟；KPI指标与明细报表数据一致。

[302] 设备健康分析
- 用户故事：作为运维人员，我需要快速定位有健康问题的设备（如低电量、离线），以便及时处理。
- 功能点说明：
  - 报表形式：列表与筛选
  - 核心视图：
    - **问题设备列表**：默认展示所有“低电量”或“离线”的设备。
    - 列表字段：房间号、设备ID、设备型号、状态（低电量/离线）、电量百分比、最后在线时间。
  - 筛选与排序：
    - 支持按状态（低电量/离线）筛选。
    - 支持按“电量”或“最后在线时间”排序，帮助优先处理最紧急的设备。
  - 交互：
    - 点击列表中的设备，可查看该设备近期的事件历史（如开门记录、告警记录）。
- 验收标准：列表信息准确，能正确反映设备当前（或最近一次上报）的状态；排序和筛选功能正常。

[303] 异常行为监控
- 用户故事：作为安保或管理人员，我需要了解潜在的风险事件，如暴力开门、门未关好等。
- 功能点说明：
  - 报表形式：事件流（Event Stream）
  - 核心视图：
    - **异常事件流**：按时间倒序展示所有被定义为“异常”的门锁事件。
    - 异常类型包括：强制开门（Tamper）、超时未关、连续多次开门失败、非授权时段开门等。
    - 事件条目内容：事发时间、房间号、设备ID、异常类型、关联卡号（如有，需脱敏）。
  - 筛选与交互：
    - 支持按“异常类型”和“时间范围”进行筛选。
    - 点击任一事件，可查看该事件前后的相关日志，帮助还原现场情况。
- 验收标准：异常事件捕获规则明确且可配置；事件流展示实时性高（延迟 < 1分钟）；所有敏感信息（如卡号）必须脱敏展示。

---

## 4xx 导出与每日简报

[401] 导出 CSV/PNG
- 用户故事：作为用户，我可导出图表或表格用于汇报。
- 功能点说明：
  - 导出触发入口：
    - 在所有支持导出的报表（3xx 相关页面）统一提供“导出”按钮；
    - 文本为“导出”，点击后下拉选择“导出 CSV”或“导出 PNG”；
    - 导出按钮需受权限控制（例如部分敏感报表仅管理员可导出明细）。
  - CSV 导出规则：
    - 编码格式：UTF-8 无 BOM；
    - 第一行输出字段名，后续每行为一条记录；
    - 数值字段默认保留 4 位小数，百分比字段以 % 展示；
    - 文件首部或尾部需增加一段“查询条件与口径说明”，包括：时间范围、过滤条件摘要、主要指标定义来源（引用 `ReportingSpecs.md`）。
    - 明细导出需设置最大行数（例如 5 万行），超出时给出提示“数据量过大，请缩小筛选范围或使用订阅”。
  - PNG 导出规则：
    - 分辨率：默认 1080p（1920×1080）或等比例缩放，确保投屏展示清晰；
    - 图形内容需包含：图表主体、标题、副标题（如时间范围）、图例、坐标轴标签；
    - 多图场景（如一个页面包含多个图表）时，仅导出当前选中的主图表，避免一张图过于拥挤。
  - 文件命名规范：
    - 统一命名格式：`<报表名>_<门店/范围>_<起止日期>_<生成时间>.{csv|png}`；
    - 门店/范围过长时可截断或使用“多门店”等简写；
    - 生成时间使用 UTC 或门店本地时间，需在文档中说明一致的策略。
  - 权限与审计：
    - 导出行为需写入审计日志，包括：导出人、时间、报表类型、导出类型（CSV/PNG）、记录数（对 CSV）；
    - 对包含明细数据的导出（如事件列表）需校验用户是否具备相应数据范围权限，防止跨门店导出。
- 验收标准：导出成功率 ≥ 99%；文件内容与当前页面视图在维度/指标/过滤条件上保持一致。

[402] 每日运营简报（重构）
- 用户故事：作为店长，我每天上班登录系统时，希望 AI 主动告诉我昨天发生了什么，而不是我去查报表。
- 功能点说明：
  - 触发机制：
    - 每日 08:00（可配）后，用户首次登录系统时触发。
    - 形式为右下角弹出的 Toast 卡片或对话框气泡。
  - 简报内容：
    - **昨日核心数据**：总通行人次、平均开门成功率。
    - **异常提醒**：昨日发生的告警总数、当前待处理的低电/离线设备数。
    - **趋势摘要**：一句话点评（如“昨日通行量较上周同期增长 10%”）。
  - 交互：
    - 提供“查看详情”按钮，点击跳转到 [301] 运营健康概览。
    - 提供“我知道了”按钮，点击关闭。
- 验收标准：每日仅提示一次；数据与 3xx 报表一致。

---

## 5xx 权限与租户隔离

[501] SSO 与账号映射
- 用户故事：作为用户，我使用门锁系统账号免登使用 AI 助手。
- 功能点说明：
  - 接入方式：
    - 复用现有门锁系统的登录态（SSO/单点登录方案），AI 助手不单独提供用户名密码登录；
    - 支持在嵌入页面中通过前端 SDK 或后端网关方式获取当前登录用户的唯一标识（`user_id`）与租户 ID。
  - 角色与数据范围映射：
    - 登录后，后端根据 `user_id` 拉取该账号在门锁系统中的角色（前台/工程/运营/管理员等）和数据范围（可见门店/楼层）；
    - 建立一份本地“用户权限快照”，用于对 AI 查询/报表/知识库等所有请求做权限校验；
    - 支持缓存权限快照一段时间（例如 5 分钟），但需提供刷新机制（角色变动后可即时生效）。
  - 会话与单点退出：
    - AI 助手与门锁系统共享会话生命周期：门锁系统登出时，AI 助手前端需立即清除本地会话并跳转到未登录状态；
    - 当后端检测到门锁系统会话失效（token 过期或被撤销）时，AI 接口返回未授权错误，前端触发刷新/跳转逻辑。
  - 多租户隔离：
    - `user_id` 与 `tenant_id` 必须在所有 API 请求中携带，后端禁止跨租户访问；即使前端构造跨租户请求也要被拒绝；
    - 不同租户的用户在 UI 中看不到对方的任何报表、模板、知识库或订阅记录。
- 验收标准：登录成功率 ≥ 99.9%；登录/退出后 AI 助手状态与主系统保持一致，用户看不到越权门店数据。

[502] RBAC 与数据范围
 - 用户故事：作为管理员，我控制不同角色的功能与数据可见范围。
 - 功能点说明：
  - 角色模型：
    - 至少区分角色：前台/客房/工程/运营/经理/管理员（具体枚举可按实际系统定义）；
    - 不同角色的功能访问矩阵明确，例如：
      - 前台：可使用 AI 问答、查看与自己门店相关的基础报表，不可创建自助报表模板、不可导出明细；
      - 运营/经理：可创建/编辑自助报表模板、配置订阅、导出聚合报表；
      - 管理员：可管理知识库、配置全局参数、查看全租户或全集团范围（若有多层租户）。
  - 数据范围粒度：
    - 支持按“集团/区域/门店/楼层/房间”粒度配置数据范围（具体层级可和主系统对齐）；
    - 每次数据查询（事件、报表、知识库命中等）都基于用户的数据范围进行过滤：
      - 例如，一个区域经理只能看到自己区域内门店的 3xx 报表结果。
  - 权限校验点：
    - 在以下关键路径统一做 RBAC + 数据范围校验：
      - AI 对话触发数据查询（2xx → 3xx 报表）；
      - 报表查看、导出（4xx）；
      - 知识库管理与发布（内置知识库更新）；
      - 简报配置（4xx）。
    - 越权请求行为需统一返回授权错误，并在审计日志中记录（关联 6xx）。
  - 配置与变更：
    - 权限配置以门锁系统为主，本模块不再提供独立用户/角色管理 UI，而是基于门锁系统提供的接口拉取角色/范围信息；
    - 当门锁系统中角色或数据范围发生变更时，AI 权限需在合理时间内同步（例如通过定时拉取或事件推送），避免出现“权限已收缩但还能查到旧数据”的窗口。
 验收标准：设计的越权场景用例（跨门店报表、导出他店明细、访问未授权知识库文档等）100% 被拦截，且有对应审计记录；合法场景不被误拦。

---

## 6xx 模型安全、配置与工程约束

说明：本模块覆盖模型与系统行为的安全、配置、监控和降级四个方面，作为贯穿所有功能模块的横切能力。

[600] AI 模型部署方式
- 用户故事：作为单店管理者，我需要根据门店的网络条件和数据安全要求，灵活选择本地部署或外部调用的方式使用 AI 助手。
- 功能点说明：
  - 部署模式：
    - **本地部署模式（推荐）**：
      - 适用场景：国际连锁酒店单店，具备独立机房/服务器，对 GDPR 及数据隐私有极高要求。
      - **数据隐私承诺**：明确承诺“住客数据不出酒店（Guest data never leaves the hotel premise）”，所有推理在本地服务器完成。
      - 模型要求：支持在本地服务器或边缘设备上部署轻量级大语言模型（如 7B-13B 参数规模），能够满足对话、RAG 检索、意图识别等核心功能；
      - 硬件建议：最低配置为 16GB 内存、支持 GPU 加速（可选，但推荐用于提升响应速度）；
      - 离线能力：本地部署后，核心对话与知识库检索功能可在完全离线状态下运行，报表生成依赖本地数据库；
      - 模型更新：支持通过离线安装包或低频联网方式更新模型版本和知识库内容。
    - **外部调用模式（云端 API）**：
      - 适用场景：门店网络稳定、希望使用更强大的模型能力、无需本地维护基础设施的环境；
      - 调用方式：通过 HTTPS API 调用云端大语言模型服务（如 OpenAI API、Azure OpenAI、国内主流大模型 API 等）；
      - 网络要求：稳定的互联网连接，建议带宽 ≥ 10Mbps，延迟 < 200ms；
      - 数据传输：所有数据传输必须加密（TLS 1.2+），敏感数据在传输前进行脱敏处理；
      - 降级策略：当外部 API 不可用时，自动降级到本地缓存的常见问题答案或提示用户稍后重试。
  - 混合模式（可选）：
    - 支持"本地 + 云端"混合部署：常规对话和检索使用本地模型，复杂分析或需要更强推理能力的任务可选择性调用云端 API；
    - 通过配置中心灵活切换或组合使用两种模式。
  - 配置与管理：
    - 提供配置界面或配置文件，允许管理员选择部署模式、配置 API 端点、设置模型参数（如温度、最大 token 数）；
    - 对于本地部署，提供模型加载状态监控、性能指标（响应时间、GPU 利用率等）和日志查看功能；
    - 对于外部调用，提供 API 调用成功率、平均延迟、费用统计（如有）等监控。
  - 数据隐私与合规：
    - 本地部署模式：所有数据处理在本地完成，不向外部传输任何业务数据或用户问题；
    - 外部调用模式：必须确保调用的云端服务符合数据隐私法规（如 GDPR、《个人信息保护法》），并在用户协议中明确告知；
    - 无论哪种模式，都不得将住客姓名、证件号、订单号等敏感 PII 发送给 AI 模型（关联 601 脱敏规则）。
- 验收标准：
  - 本地部署模式可在完全离线环境下正常运行对话与 RAG 检索功能，响应时间 p95 ≤ 5s；
  - 外部调用模式在网络正常时响应时间 p95 ≤ 3s，API 不可用时能够降级并给出明确提示；
  - 两种模式可通过配置灵活切换，切换后系统功能正常，不出现数据丢失或功能异常；
  - 所有模式下均不泄露未脱敏的 PII 数据。

[601] 审计与脱敏
- 用户故事：作为合规和安全负责人，我需要追溯关键操作与问答行为，知道谁在什么时候对哪些数据做了什么，同时确保在日志和回答中不会泄露住客隐私。
- 功能点说明：
  - 审计范围：
    - 记录以下关键操作：登录/登出、权限变更、知识库文档上传/发布/回滚、报表导出（4xx）、简报查看（402）、越权访问被拦截事件（502）、通过 MCP 或其他接口发起的数据查询异常（7xx）。
  - 审计内容（最小必要）：
    - 每条记录至少包含：时间戳、操作者及角色、租户/门店范围、操作类型、操作对象标识、结果（成功/失败）、错误原因摘要（如有）；
    - 对话相关操作仅记录"问题摘要 + 处理结果类型"（命中知识库/数据查询/兜底等），不保留完整问题文本和原始上下文。
  - 脱敏与最小化：
    - 明确敏感数据范围（住客姓名、手机号、邮箱、证件号、房卡卡号、订单号、证件照片、支付信息等）以及业务敏感信息（内部账号、设备密钥等），按等级配置脱敏/屏蔽规则；
    - 在数据查询与报表接口中，对涉及敏感字段默认不返回，仅在功能明确需要且经过脱敏时才返回（如手机号后 4 位 `138****5678`）；
    - 在 AI 回答生成阶段，对模型输出做敏感模式检测，命中时替换为掩码或提示语；审计记录和监控数据中禁止写入原始敏感信息。
  - 查询、导出与留存：
    - 提供按时间、操作者、操作类型过滤审计记录的能力，仅授权管理员可查询与导出；
    - 审计日志默认留存不少于 90 天，之后可按租户策略归档或删除，对有更高合规要求的租户支持更长留存期。
- 验收标准：核心操作审计日志完整率 100%；抽检回答和日志样本中不出现未脱敏的 PII；脱敏规则及其变更可追溯。

[602] 异常与降级体验
- 用户故事：作为用户，我希望在系统无法正常响应时（查询无结果、报表超时、数据不完整等），能获得清晰的提示和下一步建议，而不是卡住或得到错误答案。
- 功能点说明：
  - 无命中与澄清：
    - 当 RAG 或意图识别无可靠结果时，必须返回明确的无命中提示，而不是"编一个答案"；
    - 提供 2–3 条改写建议或澄清问题，用户点击即可二次检索。
  - 超时与后台处理：
    - 对复杂报表设置统一超时阈值（默认 8 秒，可配置）；
    - 超时时将任务转为后台执行，通过通知告知用户结果可用，结果在限定有效期内可重复查看而无需重算。
  - 部分结果提示：
    - 在上游数据部分不可用时，以明显的"部分结果"标记和说明提示用户；
    - 对缺失比例过高的情况，允许直接提示"数据不完整，建议稍后再试"，而不是给出误导性汇总。
- 验收标准：无命中、超时、部分结果等场景下，用户都能获得清晰的提示与下一步建议；不出现"编造答案"或"静默失败"的情况。

[603] 内容安全护栏 (AI Shield)
- 用户故事：作为管理员，我希望系统能自动拦截恶意输入和不当输出，确保 AI 助手的回答安全、合规且不产生幻觉。
- 功能点说明：
  - 护栏机制（双向拦截）：
    - 为了兼顾安全与合规，系统需在“输入”和“输出”两个环节分别设置护栏：
    - **输入护栏（Input Guardrail）**：在调用大模型生成之前执行。
      - 对象：用户原始提问 + (可选) 检索到的 RAG 上下文。
      - 目的：拦截 Prompt Injection（提示词注入）、恶意指令攻击；防止检索到被污染的知识误导模型。
    - **输出护栏（Output Guardrail）**：在大模型生成回答之后、返回给用户之前执行。
      - 对象：模型生成的最终文本。
      - 目的：拦截幻觉（Hallucination）、未脱敏 PII、不当言论、政治敏感内容。
  - 检测维度：
    - **内容合规性**：检测是否包含暴力、色情、仇恨言论、政治敏感等违规内容（主要针对大模型生成的自由文本）。
    - **指令攻击防御**：检测用户输入是否存在 Prompt Injection（提示词注入）攻击风险，防止模型被诱导输出系统指令。
    - **数据隐私二次校验**：对即将输出的文本进行正则扫描，确保没有未脱敏的 PII（如手机号、身份证号）遗漏。
    - **幻觉与一致性（高级）**：对于数据分析类回答，校验生成的文本摘要是否与结构化数据结果存在明显矛盾（如数据是“上升”，文本说“下降”）。
  - 处置策略：
    - **拦截与阻断**：发现严重违规（如有害内容）时，直接拦截输出，返回通用错误提示（“检测到不当内容，已停止生成”）。
    - **替换与降级**：发现轻微风险或 PII 泄露风险时，自动替换为掩码（`****`）或降级为仅展示结构化数据卡片，不展示分析文本。
    - **审计与告警**：所有触发护栏的拦截行为均需记录高优审计日志，并支持向管理员发送实时告警。
  - 部署适配：
    - **本地模式**：采用轻量级分类模型（如 BERT-tiny）或关键词/正则规则库，保障低延迟。
    - **云端模式**：调用云厂商提供的内容安全 API（Content Safety API）。
- 验收标准：
  - 恶意攻击样本拦截率 ≥ 95%；
  - 敏感隐私数据输出拦截率 100%；
  - 护栏处理延迟 < 200ms（本地）或 < 500ms（云端），不显著影响用户体验。

[604] 本地推理引擎与工程约束（新增）
- 用户故事：作为研发团队，我需要明确本地部署的技术选型边界，确保在单店硬件上跑得动、跑得稳。
- 功能点说明：
  - **硬件基线（Hardware Baseline）**：
    - 目标环境：单店独立服务器（On-Premise Server）。
    - 最低配置：CPU (Intel Xeon/Core i7) + 32GB 内存（考虑到需承载业务系统 + AI）。
    - 推荐配置：NVIDIA GPU (RTX 3060 12GB 及以上) 以获得更佳体验。
    - 必须支持纯 CPU 推理模式（作为无 GPU 环境的兜底）。
  - **模型选型约束**：
    - 参数规模：推荐 **7B - 14B** 参数量（如 Qwen2.5-7B, Llama-3-8B）。
    - 量化要求：必须支持 **4-bit (Int4) 量化**，显存/内存占用控制在 8GB 以内。
    - 上下文长度：支持至少 8k context window。
  - **推理框架与交付**：
    - **推荐框架**：集成 **Ollama** 或 **vLLM** 作为底层推理引擎，屏蔽硬件差异，提供标准 OpenAI 兼容接口。
    - **交付形式**：提供 Docker 镜像或一键安装包（.exe/.dmg），内含模型权重文件，**严禁现场联网下载模型**。
  - **性能指标（验收标准）**：
    - 首字响应时间（TTFT）：GPU 环境 < 1s，CPU 环境 < 3s。
    - 生成速度：GPU 环境 > 30 tokens/s，CPU 环境 > 5 tokens/s。
- 验收标准：在基线硬件上成功部署并流畅运行；断网环境下功能完整。

---

## 7xx 数据接入与集成（预置）

[701] 预置 MCP 工具集
- 用户故事：作为用户，我不需要配置任何数据库连接，AI 出厂就能查我的数据。
- 功能点说明：
  - **预置集成**：
    - 所有 MCP 工具（查询事件、查询设备、查询告警）均针对门锁系统原生数据库结构进行**硬编码适配**。
    - 配置文件中预置好 SQL 模板或 API 映射关系。
  - **零配置**：
    - 用户界面无 MCP 配置入口。
    - 系统启动时自动加载本地数据库连接信息。
  - **工具清单（示例）**：
    - `get_device_status(device_id)`
    - `search_events(start_time, end_time, filters)`
    - `get_daily_stats(date)`
    - `diagnose_system()` (供 208 巡检使用)
    - **`get_room_occupancy(room_id)`**：查询房间当前的入住状态、入住人脱敏信息、入住起止时间。
    - **`get_card_validity(card_id)`**：查询卡片类型、有效期、权限范围。
- 验收标准：安装即用，无需人工介入配置数据源。

---

## 统一非功能与验收（1.0）
- 性能：对话首响应 p95 ≤ 3s；复杂报表 ≤ 8s。
- 可用性：月度 99.9%；关键路径具备重试与降级。
- 安全：越权 100% 拦截；PII 不出现在答案/日志；数据加密传输/存储。
- 质量：FAQ Top1 可用 ≥ 85%；数据查询解析成功 ≥ 90%；导出成功 ≥ 99%。
- 合规：日志留存 90 天；最小化收集；可删除/可留存策略到位。

参考
- 数据模型：`docs/DataModel.md`
- 报表口径：`docs/ReportingSpecs.md`
