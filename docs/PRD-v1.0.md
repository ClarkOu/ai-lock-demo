# AI 助手 for 酒店门锁系统 — v1.0 功能型 PRD（按功能位）

版本：v1.0（草案）  
日期：2025-11-13  
负责人：产品/研发/数据/安全联合

阅读指引：本稿按“模块/页面 → [编号] 功能名称 → 用户故事 → 功能点说明 → 验收标准”的格式组织。UI 细节与原型另行提供；指标口径见 `docs/ReportingSpecs.md`，数据模型见 `docs/DataModel.md`。

## 模块索引
- 1xx 全局与入口
- 2xx 对话与问答（Chat/RAG）
- 3xx 知识库管理
- 4xx 预置报表
- 5xx 自助报表与模板
- 6xx 导出与订阅
- 7xx 权限与租户隔离（SSO/RBAC/数据范围）
- 8xx 模型安全、配置与可观测
- 9xx 数据接入与集成

---

## 1xx 全局与入口

[101] 全局入口与会话入口
- 用户故事：作为任一登录用户，我希望随时打开 AI 助手发起对话或报表请求。
- 功能点说明：
  - 入口形态与位置：
    - 在现有门锁系统所有业务页面右下角常驻一个 AI 助手入口图标（悬浮按钮），不遮挡关键操作区域。
    - 悬浮按钮点击后展开主会话面板（侧边抽屉或弹窗），再次点击可最小化回到按钮形态。
    - 支持拖动调整入口按钮位置（仅在当前浏览器会话内生效，不做跨设备持久化）。
  - 打开方式与快捷键：
    - 点击入口按钮可打开/关闭会话面板；
    - 支持快捷键：Mac 为 `Cmd+J`，Windows 为 `Ctrl+J`（如不冲突），按下时：
      - 若当前未打开会话面板，则打开并自动聚焦输入框；
      - 若已打开，则关闭面板。
  - 会话管理：
    - 会话列表默认展示最近 20 个会话，按最近活动时间倒序排列；
    - 支持会话搜索（按会话标题和最近若干条问题文本关键词匹配）；
    - 支持会话置顶（最多置顶 10 个），置顶会出现在列表顶部；
    - 支持重命名会话标题（默认标题为“来自第一个问题的前若干个字”）；
    - 支持归档会话：归档后不再出现在默认列表，只在“已归档”视图中可见。
    - 系统最多保留最近 200 条活动会话（含归档）；超出时按“最早未置顶会话”原则自动清理，清理前给出提示。
  - 数据范围自动生效：
    - 打开会话时，根据当前登录用户的租户/门店权限自动设置数据上下文（例如“X 酒店-杭州店”）；
    - 会话标题区域以标签形式展示当前数据范围；当用户在门锁系统中切换门店时，新发起的会话使用新的范围，但旧会话保留创建时范围记录（只用于审计，不改变权限）。
- 验收标准：入口可达率 100%；会话基本操作成功率 ≥ 99.9%。

[102] 时间与时区一致性
- 用户故事：作为区域经理，我希望跨门店统计在各自本地时区准确聚合。
- 功能点说明：
  - 统一 UTC 存储
  - 按 `property.timezone` 转换展示
  - 跨日界与夏令时正确分段
  - 支持自然语言时间查询（如“上周一到周日”）
- 验收标准：与对账报表误差 < 0.5%；随机抽样 50 条跨日界场景均正确。

---

## 2xx 对话与问答（Chat/RAG）

[201] 会话创建与上下文管理
- 用户故事：作为运营，我可以发起新对话或延续历史并引用历史上下文。
- 功能点说明：
  - 新建会话：
    - 用户在任意页面点击 AI 入口按钮或“新建会话”按钮时，创建一个新的会话实例；
    - 新会话的默认标题为“未命名会话”，在用户发送第一条消息后，用第一条问题内容前若干字（例如前 20 字）自动替换标题；
    - 新会话创建时会记录当前用户的租户/门店上下文，用于后续数据查询权限校验及审计（不会随页面切换自动变更）。
  - 继续会话：
    - 从会话列表点击任意历史会话时，拉起该会话历史对话记录；
    - 历史消息按时间顺序展示，支持向上滚动加载更多历史（分页加载，每次 20 条）；
    - 用户在历史会话中发送新消息时，沿用该会话既有上下文和数据范围。
  - 上下文窗口与自动摘要：
    - 上下文窗口限制：系统在给大模型构造提示时，只携带最近 N 轮对话内容（默认 N=20，按“用户+助手”的一问一答算一轮），超过部分不再原文传入；
    - 当会话累计轮数超过 N 时，系统需对较早的对话机器人侧生成“会话摘要”，包括：用户目标、关键约束、已确认的结论等，并将摘要作为压缩上下文；
    - 摘要内容会展示在会话顶部的“上下文摘要”区域，用户可展开查看，但不可编辑；
    - 若摘要失败（模型调用异常等），系统仍可继续对话，但需在日志中记录，以便后续排查。
  - 固定资料片段（Pin 机制）：
    - 用户可将某些知识库片段或文档（例如某个 SOP 章节）“固定”到当前会话，最多 3 个；
    - 被固定的条目会在会话侧栏以标签形式展示，包含标题与简短描述；
    - 在生成回答时，固定片段会被优先加入检索上下文，优先级高于普通检索结果；
    - 用户可随时取消固定，取消后后续回答不再强制使用该片段。
  - 会话搜索与管理：
    - 支持按会话标题搜索；
    - 支持按最近若干条问题的文本进行模糊搜索（例如最近 3 条消息中的文本）；
    - 搜索结果按最近活动时间降序排列。
- 验收标准：摘要不改变事实；固定片段在 95% 情况下被优先检索。

[202] 意图识别与分流
- 用户故事：作为用户，我提问后系统能识别 FAQ/SOP/数据查询/报表生成并走合适流程。
- 功能点说明：
  - 意图类别：至少支持以下一级意图：
    - FAQ/规则类：适合直接从知识库中检索标准答案（例如“入住时间规定是什么？”、“如何重置门锁？”）；
    - 操作指南/SOP 类：需要从 SOP 文档中抽取步骤或流程（例如“更换电池的步骤是什么？”）；
    - 数据查询/临时报表类：需要访问事件/设备等数据源并返回表格或图表（例如“最近7天门店A的开门失败率趋势”）；
    - 预置报表跳转类：用户提到具体报表名或典型描述（例如“打开开门成功率报表”、“看一下门店对比排行榜”）；
    - 闲聊/非业务类：系统可以简单响应或引导用户回到业务问题。
  - 分类器输出：
    - 对每条用户消息，意图识别模块输出：`intent_type`、`sub_type`（可选）、`confidence`（0~1）、解析的结构化信息（如时间、对象等）；
    - 当 `confidence` 高于配置阈值（例如 0.7）时，直接按识别结果进行分流；
    - 当 `confidence` 低于阈值时：
      - 系统不直接调用工具，而是向用户发出澄清提问（例如“你是想查询数据，还是查看操作指引？”）；
      - 若用户仍未给出清晰选择，则走保守路径（一般优先 FAQ/RAG，避免误触发数据写操作——1.0 暂无写操作）。
  - 分流逻辑：
    - FAQ/SOP 类：走知识检索流程（见 203），不调用数据服务；
    - 数据查询/临时报表类：走 204 所述的“意图→结构化查询”流程，并返回结果卡片；
    - 预置报表跳转类：直接构造对应报表的默认参数（如最近 7 天、当前门店），并跳转至对应报表页面或返回报表卡片；
    - 闲聊类：调用通用对话模型，同时限制回答不触及隐私/合规红线。
  - 可配置项：
    - 支持在后台配置意图阈值、启用/禁用某些意图类型（例如在某租户禁用“闲聊”）；
    - 支持对某些关键句型做规则兜底（如“生成 XX 报表”直接映射到指定报表）。
- 验收标准：意图识别准确率（人工评测）≥ 90%。

[203] RAG 检索与引用标注
- 用户故事：作为用户，我希望答案有明确来源引用，便于核查。
- 功能点说明：
  - 检索流程：
    - 根据用户问题和当前会话摘要（若有）构造检索查询向量；
    - 在向量库中按相似度检索 TopK 段落（默认 5，最大 10），同时在全文索引中做关键词召回，合并去重；
    - 对检索结果按相似度和文档权重（如是否最新版本、是否标记为“推荐”）进行重排序。
  - TopK 与阈值：
    - 支持在配置中设置 `top_k`（默认 5）和相似度阈值（例如 0.7）；
    - 若所有候选段落相似度均低于阈值，则认为“无有效命中”；
    - 对于命中但相似度较低（例如介于 0.5~0.7）时，可以作为“参考资料”附在回答后半部分，而不是直接作为主依据。
  - 上下文构造与答案生成：
    - 将精选后的 3~5 段落按文档与章节顺序拼接，作为大模型的知识上下文部分；
    - 提示词中要求模型：
      - 只能基于给定上下文回答，不得凭空编造；
      - 对于每条关键结论，尽量引用至少一个来源段落。
  - 引用标注格式：
    - 在答案末尾列出引用列表，格式包括：
      - 文档标题；
      - 版本号/生效日期（若有）；
      - 段落标题或所在章节；
      - 页码（针对 PDF 等有页码的文档）；
    - 在正文中，对于引用来源的句子，可以使用简短编号标注（例如“[1]”），编号与引用列表对应。
  - 无命中与兜底：
    - 当所有结果相似度低于阈值时：
      - 不生成具体回答内容，而是返回“未检索到可靠依据”的提示；
      - 同时列出若干相近的知识库文档标题或常见问题作为建议链接；
      - 提示用户可以提供更具体的关键词或截图。
  - 配置与监控：
    - 支持对不同租户配置不同的检索策略（如更偏向 SOP vs FAQ）；
    - 埋点记录：检索命中率、平均 Top1 相似度、人工反馈“有用/无用”的比率，用于后续调优。
- 验收标准：引用覆盖率 ≥ 95%；错误引用 ≤ 1%。

[204] 数据查询意图转结构化查询
- 用户故事：作为运维，我用自然语言描述条件，系统生成表格结果。
- 功能点说明：
  - 入口形式：
    - 用户在对话框中输入自然语言问题，例如：“近30天开门失败率>3%的门店有哪些？”、“列出本周低电池告警次数最多的前10个设备”。
    - 系统在后台对每条消息先做意图分类：若判定为“数据查询/报表类意图”，则进入本功能流程。
  - 解析内容（意图 → 结构化查询对象）：
    - 时间范围：
      - 支持绝对时间（“2025-01-01 至 2025-01-31”）与相对时间（“最近7天”、“上周”、“本月”）。
      - 未明确时间时，默认时间范围为最近 7 天，并在结果上方显式展示默认范围。
    - 维度：
      - 从语句中识别出分组维度（如门店、房间、设备型号、小时、星期几等），映射到 `DataModel.md` 中对应字段（如 `property_id`、`room_id`、`device.model`、本地小时等）。
      - 若用户未指定维度但语义明显需要（例如“排名前10个门店”），系统自动选择合适的维度（如门店）。
    - 指标：
      - 识别常见指标词：失败率、成功率、次数、告警数、设备数、占比等，并映射到 `ReportingSpecs.md` 中既定公式。
      - 一个查询中可包含 1~3 个指标（例如：开门失败率、开门尝试次数、失败次数）。
    - 过滤条件：
      - 从语义中抽取条件：门店范围、楼层、房型、设备型号、事件类型、卡类型、来源（card/mobile/staff）、原因码等。
      - 支持简单比较：`>`、`<`、`>=`、`<=`、`=`（例如“失败率>3%”、“超过 50 次告警”）。
    - 排序与限制：
      - 默认按主要指标降序排列（如“失败率最高的门店”）。
      - 支持 TopN 语义（“前10”、“Top 5”），N 最大不超过 100。
  - 统一查询模型与校验：
    - 将上述解析结果构造成内部“查询描述对象”（Query DTO），包含：time_range、dimensions[]、metrics[]、filters[]、sort_by、limit 等字段。
    - 在进入数据服务前进行严格校验：
      - 所有字段必须来自白名单（避免任意 SQL 字段注入）。
      - 所有操作符在允许列表中（例如只允许 `=, >, <, >=, <=, in`）。
      - 对于率类指标，自动增加必要的过滤（如只统计 `event_type in ('open','fail')`）。
  - 业务规则与口径：
    - 默认过滤 `device.status in ('active','online')`，除非用户明确要求包含离线/停用设备（此类特殊需求不在 1.0 UI 中暴露，仅通过运营配置）。
    - 分母为 0 时，该行指标返回 NULL（前端显示为 “—”），不报错。
    - 与预置报表（4xx 模块）使用同一套聚合逻辑与代码路径，避免“聊天查出来”和“报表查出来”不一致。
  - 分页与限流：
    - 单次交互默认返回前 100 行数据，最大不超过 5,000 行。
    - 当内部结果集超过 5,000 行时：
      - 对话界面只展示前 100 行；
      - 同时提供“导出全部”入口，引导用户走导出功能（受导出权限与审计控制）。
    - 对同一会话、同一用户，在单位时间内的结构化查询调用设置限流阈值（如每分钟 10 次），超过后返回友好错误提示。
  - 结果展示：
    - 对话中以“结果卡片”的形式展示表格，表头为维度+指标名称，支持横向滚动。
    - 结果卡片顶部展示：自然语言查询摘要、解析出的时间范围与主要过滤条件，便于用户核对。
    - 用户可在卡片上点击“调整条件”进入轻量配置面板（时间/门店/TopN 等），重新发起查询。
- 验收标准：解析成功率 ≥ 90%；对照 SQL 抽检 50 条无口径偏差。

[205] 结构化结果卡片（表格/图表）
- 用户故事：作为经理，我要在对话中直接看到图表并能导出。
- 功能点说明：
  - 卡片类型与触发方式：
    - 当 204 数据查询或 4xx/5xx 报表通过对话触发时，系统以“结果卡片”的形式返回，而不是纯文本；
    - 支持的卡片类型包括：表格卡片、折线图卡片、柱状图卡片、饼图/环形图卡片；
    - 具体使用哪种图表类型，可由后端根据查询维度/指标推荐，也可在后续版本提供用户切换能力（1.0 先由系统自动选择）；
  - 卡片内容结构：
    - 标题栏：展示报表名称或根据用户问题生成的摘要标题（例如“近30天门店A开门失败率”）；
    - 条件说明：以一行小字列出关键查询条件（时间范围、门店范围、主要过滤条件），需与实际查询条件保持一致；
    - 主体区域：
      - 表格卡片：
        - 表头为维度列 + 指标列，至少包含维度字段名（如日期、门店）和主要指标（如成功率、次数）；
        - 支持横向滚动查看所有列；
        - 支持点击列头进行升序/降序排序（默认按主要指标降序）。
      - 图表卡片：
        - 折线/柱状：X 轴为时间或分类维度，Y 轴为数值指标；
        - 饼图/环形图：用于展示占比类指标（如各原因占比、各门店占比），限制类目数量（例如最多 10 个，其余归入“其他”）；
        - 鼠标悬停时显示 tooltip（具体值、占比、维度名称）。
    - 解读区域：
      - 在卡片底部提供一段简短的自然语言解读（1~3 句），例如“近7天开门成功率整体稳定在 98% 左右，门店A略低”；
      - 解读文案来源于模型生成，但需控制长度和避免绝对结论。
  - 交互能力：
    - 导出：卡片右上角提供导出按钮，支持导出为 CSV（表格数据）和 PNG（图表截图），具体规范见 601；
    - 复制：提供“复制为表格/Markdown”功能，将当前表格内容和条件说明复制到剪贴板；
    - 重跑：
      - 卡片提供“调整条件后重跑”入口，点击后展开轻量配置面板（如时间范围、TopN、门店选择）；
      - 用户修改参数后再次执行查询，生成新的结果卡片并在会话中追加一条消息；
    - 锚点与折叠：
      - 当同一对话中存在多个结果卡片时，支持折叠/展开卡片，避免占满屏幕；
      - 支持生成卡片的锚点链接，以便用户在长对话中快速跳回该卡片位置。
  - 异常与边界：
    - 数据为空时：
      - 在卡片主体显示“当前条件下无数据”，不展示空白图表；
      - 同时保留条件说明，便于用户修改过滤；
    - 数据量过大时：
      - 表格仅展示前 N 行（如 100 行），并在下方展示“仅显示部分结果，可通过导出查看全部”提示；
    - 当图表无法渲染（前端异常）时，至少保证表格视图可用，或提示用户刷新重试并记录异常日志。
- 验收标准：卡片渲染成功率 ≥ 99%；导出一致性与页面展示一致。

[206] 敏感信息与越权拦截
- 用户故事：作为管理员，我希望越权查询被拦截且提示清晰。
- 功能点说明：
  - 按租户/门店/角色校验；出现跨范围字段或 PII 时脱敏或拒绝。
  - 审计记录包含被拒绝原因（不含原始敏感数据）。
- 验收标准：越权样例 100% 拦截；无 PII 外泄。

[207] 指令模板与快捷提示
- 用户故事：作为新手，我希望快速上手常用问题与报表。
- 功能点说明：
  - 展示位置与数量：
    - 在对话输入框下方或上方区域，展示若干条“指令模板”气泡或按钮；
    - 默认展示 6~10 条模板，保证在常见分辨率下不产生严重换行；
  - 模板内容形式：
    - 模板由“标题 + 示例文案”组成，例如：
      - 标题：“查看开门成功率趋势”；示例文案：“最近7天门店A的开门成功率趋势”；
      - 标题：“查询低电池设备”；示例文案：“列出当前低电池设备列表”；
    - 点击模板时：
      - 将示例文案填充到输入框中，用户可编辑后再发送；
      - 也可提供“直接发送”模式（可配），即点击后立即发送该指令。
  - 动态推荐逻辑：
    - 按角色定制：
      - 运营角色优先展示报表与运营相关模板；
      - 运维角色优先展示告警、设备状态相关模板；
      - 管理角色优先展示汇总类模板（如排行榜、趋势对比）。
    - 按页面/上下文定制：
      - 当用户当前所在页面为“某门店详情”时，模板自动带上该门店作为默认过滤条件；
      - 当用户在某预置报表页面打开 AI 时，模板优先与该报表相关。
  - 配置与管理：
    - 模板集合由后台可配置，包括：标题、示例文案、适用角色、适用页面；
    - 支持启用/禁用某些模板，支持调整排序；
    - 支持按租户自定义模板集合（如大型连锁与单店版区别）。
  - 埋点与效果评估：
    - 对每个模板记录曝光次数、点击次数、点击后发送次数、最终完成查询/报表的次数；
    - 通过这些指标衡量模板效果，为后续优化提供依据。
- 验收标准：模板点击转化率 ≥ 25%；可配置且生效实时。

---

## 3xx 知识库管理

[301] 文档上传与管理
- 用户故事：作为管理员，我可以上传文档到知识库，系统自动处理并让用户在对话中检索到相关内容。
- 功能点说明（用户视角）：
  - 上传入口：
    - 在"知识库管理"页面提供上传入口，仅对具有"知识库管理员"权限的账号可见；
    - 支持单文件/批量上传，可通过浏览器选择文件或拖拽方式上传；
    - 支持格式：PDF、Docx、Markdown、纯文本（.txt）；单文件最大 30MB，每次批量最多 20 个文件。
  - 上传后处理：
    - 上传完成后显示"处理中"状态，系统自动解析文档并生成可检索内容；
    - 处理成功后文档自动发布，用户在 AI 对话中即可检索到相关内容；
    - 处理失败时显示失败原因，支持点击"重试"。
  - 文档列表管理：
    - 管理员可查看已上传文档列表，支持按文件名搜索；
    - 可查看文档状态（处理中/已发布/失败）、上传时间、文件大小；
    - 可删除不再需要的文档（删除后立即从检索中移除）。
- 功能点说明（内部实现，开发参考）：
  - 文档解析与切分：
    - 后端异步执行解析任务：文本抽取、标题/章节识别、页码提取（PDF）；
    - 按自然段落切分为 chunk，每段 500~1,000 字，记录 `doc_id`、`chunk_index`、章节标题、页码等元数据；
    - 对每个 chunk 生成向量 embedding 并写入向量库（分片存储，见 903）；
    - 解析超时时间 2 分钟，失败后支持最多 3 次自动/手动重试。
  - 元数据与分类：
    - 系统自动提取或推断文档标题（优先使用文件名或文档首行）；
    - 自动分配标签/分类（基于内容关键词或文件名模式，如"SOP"、"FAQ"、"操作指南"）；
    - 可见范围默认为"当前租户所有角色"，特殊需求可通过配置按角色/门店限制可见性（在检索时做权限过滤）。
  - 版本管理（内部）：
    - 同名文档再次上传时视为新版本，自动标记版本号（v1/v2/v3…），旧版本保留但默认不参与检索；
    - 系统维护"当前发布版本"指针，检索优先命中当前版本；
    - 支持版本回滚：管理员可在后台切换到历史版本，触发向量索引更新（见 903）；
    - 所有版本变更需记录审计日志（操作人、时间、前后版本号）。
  - 审核流程（可选，按租户配置启用）：
    - 若启用审核，上传后文档进入"待审核"状态，不参与检索；
    - 审核人通过/驳回后，文档才进入"已发布"状态；
    - 审核记录包含审核人、时间、结果、意见，可追溯。
  - 发布与索引同步：
    - 文档发布后，触发向量索引增量更新（目标 ≤ 2 分钟内可被检索）；
    - 文档删除时，对应 chunk 从向量库中标记失效或物理删除。
- 验收标准：主流格式解析成功率 ≥ 98%（重试后 ≥ 99.5%）；发布后 2 分钟内可被检索命中；删除后立即不再出现在检索结果中。

[302] 知识检索与反馈
- 用户故事：作为用户，我在对话中提问时可以自动检索到知识库内容，并能反馈答案是否有用。
- 功能点说明（用户视角）：
  - 自动检索集成：
    - 用户在 AI 对话中提问时，系统自动从知识库检索相关内容并用于生成答案（无需用户手动触发）；
    - 答案中会标注引用来源（文档标题、章节），用户可点击"查看原文"展开完整段落。
  - 反馈机制：
    - 每个 RAG 回答下方提供"有用/无用"按钮；
    - 选择"无用"时可选填原因（不准确/过时/无关）；
    - 反馈数据用于后续优化检索策略和知识库质量。
- 功能点说明（内部实现，开发参考）：
  - 检索流程（见 203）：
    - 基于用户问题和会话上下文构造查询向量；
    - 在向量库中检索 TopK 段落（默认 5，可配置），同时做关键词召回，合并去重后重排序；
    - 按相似度阈值过滤（可配置，默认 0.7），低于阈值视为无命中（触发 1201 澄清流程）。
  - 权限过滤：
    - 检索时需根据用户角色/租户/门店做可见范围过滤，避免越权命中其他租户或角色专属文档；
    - 过滤逻辑在向量库查询后、返回前端前执行。
  - 反馈数据采集：
    - 记录字段：问题摘要（不存完整问题）、命中文档 ID/版本、用户反馈（有用/无用）、原因、用户角色/租户、时间戳；
    - 写入反馈表，用于模型调优和知识库质量分析（关联 1101 质量看板）。
  - 搜索入口（可选）：
    - 可在知识库管理页面提供独立搜索框，供管理员按文件名/标签/内容片段查找文档；
    - 搜索结果展示文档标题、匹配片段、标签、版本、上传时间等，支持关键字高亮。
- 验收标准：检索响应 p95 ≤ 1.5s；引用覆盖率 ≥ 95%；反馈埋点完整且不泄露完整问题文本。

---


---

## 4xx 预置报表（3 个）
注：此为面向单店离线场景的简化版报表集。指标与公式详见 `docs/ReportingSpecs.md`。

[401] 运营健康概览
- 用户故事：作为店长，我希望在一个屏幕内快速了解门店运营的核心健康状况，包括客流、服务效率和异常情况。
- 功能点说明：
  - 报表形式：仪表盘（Dashboard）
  - 核心指标卡片（KPI Cards）：
    - **今日总通行人次**：今日内所有成功的开门事件去重后的人数（基于卡 ID 或其他身份标识）。
    - **开门成功率（近24小时）**：`成功开门次数 / (成功开门次数 + 失败开门次数)`，滚动24小时计算。
    - **低电量设备数**：当前电池电量低于 20% 的设备总数。
    - **离线设备数**：当前与系统失联超过 1 小时的设备总数。
    - **异常开门告警（今日）**：今日内发生的“强制开门”、“超时未关”等高风险事件计数。
  - 图表组件：
    - **开门成功率趋势（近7天）**：
      - 类型：折线图
      - X轴：日期
      - Y轴：每日开门成功率（%）
    - **通行人次时段分布（今日）**：
      - 类型：柱状图
      - X轴：小时（0-23）
      - Y轴：通行人次
  - 交互：
    - 默认展示近7天数据，支持按“今日”、“近30天”切换。
    - 点击任一KPI卡片可钻取到对应的详细报表（[402]或[403]）。
- 验收标准：仪表盘数据刷新延迟不超过5分钟；KPI指标与明细报表数据一致。

[402] 设备健康分析
- 用户故事：作为运维人员，我需要快速定位有健康问题的设备（如低电量、离线），以便及时处理。
- 功能点说明：
  - 报表形式：列表与筛选
  - 核心视图：
    - **问题设备列表**：默认展示所有“低电量”或“离线”的设备。
    - 列表字段：房间号、设备ID、设备型号、状态（低电量/离线）、电量百分比、最后在线时间。
  - 筛选与排序：
    - 支持按状态（低电量/离线）筛选。
    - 支持按“电量”或“最后在线时间”排序，帮助优先处理最紧急的设备。
  - 交互：
    - 点击列表中的设备，可查看该设备近期的事件历史（如开门记录、告警记录）。
- 验收标准：列表信息准确，能正确反映设备当前（或最近一次上报）的状态；排序和筛选功能正常。

[403] 异常行为监控
- 用户故事：作为安保或管理人员，我需要了解潜在的风险事件，如暴力开门、门未关好等。
- 功能点说明：
  - 报表形式：事件流（Event Stream）
  - 核心视图：
    - **异常事件流**：按时间倒序展示所有被定义为“异常”的门锁事件。
    - 异常类型包括：强制开门（Tamper）、超时未关、连续多次开门失败、非授权时段开门等。
    - 事件条目内容：事发时间、房间号、设备ID、异常类型、关联卡号（如有，需脱敏）。
  - 筛选与交互：
    - 支持按“异常类型”和“时间范围”进行筛选。
    - 点击任一事件，可查看该事件前后的相关日志，帮助还原现场情况。
- 验收标准：异常事件捕获规则明确且可配置；事件流展示实时性高（延迟 < 1分钟）；所有敏感信息（如卡号）必须脱敏展示。

## 5xx 自助报表与模板

[501] 自助报表构建器
- 用户故事：作为运营/数据分析，我希望不用写 SQL，也能用自然语言或简单配置快速搭出门锁相关的自定义报表，保存下来反复使用。
- 功能点说明：
  - 入口与权限：
    - 报表中心提供“新建自助报表”入口，仅对有“报表编辑”权限的角色开放；普通只读用户只能查看/运行已发布模板。
    - 从 AI 对话中，当用户提出“帮我做一个 XXX 报表”且意图被识别为“报表构建”，支持跳转到自助报表构建器，并自动带入部分配置（如时间范围、维度、指标等）。
  - 报表类型选择：
    - 首屏提供几种基础类型：趋势类（折线/面积图）、分布类（柱状/条形图）、对比类（多系列）、明细表格等；
    - 用户必须选择一种类型作为起点，后续可在兼容范围内切换（如趋势 ↔ 对比），但不能从单纯表格直接切换成复杂组合视图。
  - 数据域与数据源：
    - 自助报表只支持预先开放的“门锁数据域”，包括：开门事件域、告警域、设备域、房态一致性域等；
    - 每个数据域定义好可选的维度与指标（重用 4xx/`ReportingSpecs.md` 中的定义），构建器中通过下拉选择，不允许自定义原始 SQL；
    - 选择数据域后，右侧动态展示该域支持的维度列表（时间、门店、设备型号、房型等）与指标列表（尝试次数、成功率、低电设备数等）。
  - 维度与指标配置：
    - 维度配置：
      - 用户可以选择 1–3 个维度（如时间 + 门店 + 设备型号）；不同报表类型对维度个数有约束（例如趋势类必须包含时间维度）；
      - 维度顺序决定分组层级（例如先门店再设备型号）；顺序可拖拽调整；
      - 对于时间维度，支持选择粒度（日、周、月），并在图表中对应变化。
    - 指标配置：
      - 用户可选择 1–3 个指标（如尝试次数、成功率、低电占比等），并指定每个指标的展示形式（折线/柱/面积/表格列）；
      - 对百分比类指标统一以 % 展示，并控制小数位数（可在高级设置调整）。
  - 过滤与分段：
    - 时间范围：必选，默认近 30 天，最大跨度限制与对应数据域保持一致（例如开门事件最大 1 年）；
    - 通用过滤：门店、区域、房型、设备型号、卡类型等，按选定数据域自动呈现可用过滤项；
    - 高级过滤：支持简单条件组合（=、in、between，且/或），不暴露字段名，而是以业务字段展示（“设备型号 等于/属于 …”）。
  - 配置预览与运行：
    - 右侧实时预览区：用户修改维度/指标/过滤后，点击“预览”执行一次查询并更新图表/表格；
    - 对于耗时查询，显示“加载中”状态和进度提示，超时时给出友好提示并建议缩小时间范围或减少维度；
    - 预览区支持切换“图表视图/表格视图”，表格视图展示当前聚合结果的原始数据行（限制行数，如前 5,000 行）。
  - 保存为模板：
    - 用户可将当前配置保存为“自助报表模板”，需要填写：模板名称、描述、可见范围（自己/本门店/本租户）、默认时间范围；
    - 模板保存后出现在“我的报表”列表中，可按名称搜索、按创建时间/修改时间排序；
    - 保存时校验配置完整性（已选择数据域、至少一个维度/指标、时间范围设置合法），不完整时拒绝保存并明确提示缺失项。
  - 模板执行与维护：
    - 对于已保存模板，用户可以：
      - 直接运行（使用模板默认过滤）；
      - 临时调整过滤条件后运行（不会覆盖模板，只在当前会话生效）；
      - 复制为新模板（在原模板基础上修改名称和配置，保存为新的条目）。
    - 模板编辑权限：仅模板创建人和具有“报表管理员”角色的用户可编辑；其他用户可只读查看和“复制为新模板”。
- 验收标准：自助报表仅在预定义维度/指标范围内构建；模板可保存/运行/复制，且结果与 4xx 口径一致。

[502] 模板保存与分享
- 用户故事：作为区域负责人，我希望把自己配好的报表模板分享给同事或门店，让他们直接使用一致的配置。
- 功能点说明：
  - 模板可见范围与授权：
    - 每个模板有“可见范围”属性：仅自己、指定门店、全租户、指定角色（如只对工程角色开放）；
    - 创建人可以在保存或编辑时调整可见范围，但将可见范围扩大（例如从“仅自己”改为“全租户”）时，需要具备相应权限（如报表管理员）。
  - 分享方式：
    - 模板详情页提供“分享链接”功能：生成一个内部链接（包含模板 ID），接收方需要登录且对模板有访问权限才能打开；
    - 支持通过搜索模板名在报表中心直接查找到他人分享的模板（依据可见范围控制）。
  - 模板版本与变更：
    - 编辑模板配置（维度、指标、过滤）时，系统记录修改时间和修改人，保留最近 N 条变更记录（用于审计）；
    - 可选支持“锁定模板”：被锁定的模板只有管理员可以修改，其他用户可以复制一份再调整，避免破坏共用模板。
  - 与 AI 的协同：
    - 当在对话中引用某个模板（“用 XXX 模板帮我看一下上个月的数据”），AI 会调用该模板并仅替换时间范围或少量过滤；
    - AI 在推荐报表时，可以基于用户画像/历史使用记录，优先推荐用户常用的模板或上级推送的“标准模板”。
- 验收标准：分享后他人可看到且运行模板；模板编辑/访问遵守权限与可见范围。

---

## 6xx 导出与订阅

[601] 导出 CSV/PNG
- 用户故事：作为用户，我可导出图表或表格用于汇报。
- 功能点说明：
  - 导出触发入口：
    - 在所有支持导出的报表（4xx/5xx 相关页面）统一提供“导出”按钮；
    - 文本为“导出”，点击后下拉选择“导出 CSV”或“导出 PNG”；
    - 导出按钮需受权限控制（例如部分敏感报表仅管理员可导出明细）。
  - CSV 导出规则：
    - 编码格式：UTF-8 无 BOM；
    - 第一行输出字段名，后续每行为一条记录；
    - 数值字段默认保留 4 位小数，百分比字段以 % 展示；
    - 文件首部或尾部需增加一段“查询条件与口径说明”，包括：时间范围、过滤条件摘要、主要指标定义来源（引用 `ReportingSpecs.md`）。
    - 明细导出需设置最大行数（例如 5 万行），超出时给出提示“数据量过大，请缩小筛选范围或使用订阅”。
  - PNG 导出规则：
    - 分辨率：默认 1080p（1920×1080）或等比例缩放，确保投屏展示清晰；
    - 图形内容需包含：图表主体、标题、副标题（如时间范围）、图例、坐标轴标签；
    - 多图场景（如一个页面包含多个图表）时，仅导出当前选中的主图表，避免一张图过于拥挤。
  - 文件命名规范：
    - 统一命名格式：`<报表名>_<门店/范围>_<起止日期>_<生成时间>.{csv|png}`；
    - 门店/范围过长时可截断或使用“多门店”等简写；
    - 生成时间使用 UTC 或门店本地时间，需在文档中说明一致的策略。
  - 权限与审计：
    - 导出行为需写入审计日志，包括：导出人、时间、报表类型、导出类型（CSV/PNG）、记录数（对 CSV）；
    - 对包含明细数据的导出（如事件列表）需校验用户是否具备相应数据范围权限，防止跨门店导出。
- 验收标准：导出成功率 ≥ 99%；文件内容与当前页面视图在维度/指标/过滤条件上保持一致。

[602] 订阅调度
- 用户故事：作为经理，我可设置每周/月自动发送报表到邮箱。
- 功能点说明：
  - 订阅对象：
    - 支持对预置报表（4xx）和自助报表模板（5xx）创建订阅；
    - 每个订阅绑定一个具体报表配置（含过滤条件），执行时按当前配置生成报表。
  - 调度计划：
    - 支持日/周/月三种计划类型：
      - 日：每天固定时间发送；
      - 周：每周固定星期几 + 时间；
      - 月：每月固定日期（如每月 1 号）+ 时间；
    - 默认最大频率为“每日 1 次”，防止频繁触发；
    - 所有时间均以租户/门店预设时区为基准，前端需展示明确的时区提示。
  - 收件人与模板：
    - 收件人支持填写一个或多个内部邮箱地址（可选支持配置通讯录）；
    - 邮件主题与正文支持简单模板变量（如报表名、时间范围），由系统提供若干默认模板；
    - 为避免信息泄露，订阅仅允许发送给与租户关联的公司域名邮箱（可配置白名单规则）。
  - 执行与权限：
    - 每次调度执行前，需基于“订阅创建者”的权限重新校验数据范围：
      - 若创建者权限已被收缩（例如从全国改为单区域），订阅生成的报表也必须自动收缩；
      - 若创建者账号被禁用，则该订阅停止执行并标记为“暂停（权限失效）”。
    - 生成报表后作为附件发送（CSV/PNG 或 PDF，如有），邮件中简要说明生成时间和口径。
  - 失败重试与通知：
    - 调度执行失败（如查询超时、邮件发送失败）时，支持自动重试最多 N 次（例如 3 次），重试间隔逐步退避；
    - 连续失败后，将订阅状态标记为“异常”，并向订阅创建者发送告警邮件或站内通知；
    - 提供订阅历史执行记录列表：包括执行时间、状态（成功/失败/部分成功）、错误原因摘要等。
  - 管理与取消：
    - 用户可以在“我的订阅”列表中查看、编辑和删除自己的订阅；
    - 管理员可以查看本租户所有订阅，并有权停用任何订阅（例如因安全策略调整）；
    - 编辑订阅时，变更应从下一个周期起生效，当前周期不追溯修改。
- 验收标准：订阅执行准点率 ≥ 99%；失败有可追踪记录与重试上限，权限变更能即时反映到后续订阅结果中。

---

## 7xx 权限与租户隔离

[701] SSO 与账号映射
- 用户故事：作为用户，我使用门锁系统账号免登使用 AI 助手。
- 功能点说明：
  - 接入方式：
    - 复用现有门锁系统的登录态（SSO/单点登录方案），AI 助手不单独提供用户名密码登录；
    - 支持在嵌入页面中通过前端 SDK 或后端网关方式获取当前登录用户的唯一标识（`user_id`）与租户 ID。
  - 角色与数据范围映射：
    - 登录后，后端根据 `user_id` 拉取该账号在门锁系统中的角色（前台/工程/运营/管理员等）和数据范围（可见门店/楼层）；
    - 建立一份本地“用户权限快照”，用于对 AI 查询/报表/知识库等所有请求做权限校验；
    - 支持缓存权限快照一段时间（例如 5 分钟），但需提供刷新机制（角色变动后可即时生效）。
  - 会话与单点退出：
    - AI 助手与门锁系统共享会话生命周期：门锁系统登出时，AI 助手前端需立即清除本地会话并跳转到未登录状态；
    - 当后端检测到门锁系统会话失效（token 过期或被撤销）时，AI 接口返回未授权错误，前端触发刷新/跳转逻辑。
  - 多租户隔离：
    - `user_id` 与 `tenant_id` 必须在所有 API 请求中携带，后端禁止跨租户访问；即使前端构造跨租户请求也要被拒绝；
    - 不同租户的用户在 UI 中看不到对方的任何报表、模板、知识库或订阅记录。
- 验收标准：登录成功率 ≥ 99.9%；登录/退出后 AI 助手状态与主系统保持一致，用户看不到越权门店数据。

[702] RBAC 与数据范围
 - 用户故事：作为管理员，我控制不同角色的功能与数据可见范围。
 - 功能点说明：
  - 角色模型：
    - 至少区分角色：前台/客房/工程/运营/经理/管理员（具体枚举可按实际系统定义）；
    - 不同角色的功能访问矩阵明确，例如：
      - 前台：可使用 AI 问答、查看与自己门店相关的基础报表，不可创建自助报表模板、不可导出明细；
      - 运营/经理：可创建/编辑自助报表模板、配置订阅、导出聚合报表；
      - 管理员：可管理知识库、配置全局参数、查看全租户或全集团范围（若有多层租户）。
  - 数据范围粒度：
    - 支持按“集团/区域/门店/楼层/房间”粒度配置数据范围（具体层级可和主系统对齐）；
    - 每次数据查询（事件、报表、知识库命中等）都基于用户的数据范围进行过滤：
      - 例如，一个区域经理只能看到自己区域内门店的 4xx 报表和 5xx 模板结果。
  - 权限校验点：
    - 在以下关键路径统一做 RBAC + 数据范围校验：
      - AI 对话触发数据查询（2xx → 4xx/5xx 报表）；
      - 报表查看、导出（6xx）；
      - 知识库管理与发布（3xx）；
      - 模板分享与订阅配置（5xx/6xx）。
    - 越权请求行为需统一返回授权错误，并在审计日志中记录（关联 8xx）。
  - 配置与变更：
    - 权限配置以门锁系统为主，本模块不再提供独立用户/角色管理 UI，而是基于门锁系统提供的接口拉取角色/范围信息；
    - 当门锁系统中角色或数据范围发生变更时，AI 权限需在合理时间内同步（例如通过定时拉取或事件推送），避免出现“权限已收缩但还能查到旧数据”的窗口。
 验收标准：设计的越权场景用例（跨门店报表、导出他店明细、访问未授权知识库文档等）100% 被拦截，且有对应审计记录；合法场景不被误拦。

---

## 8xx 安全、配置与可观测

说明：本模块覆盖模型与系统行为的安全、配置、监控和降级四个方面，作为贯穿所有功能模块的横切能力。

[800] AI 模型部署方式
- 用户故事：作为单店管理者，我需要根据门店的网络条件和数据安全要求，灵活选择本地部署或外部调用的方式使用 AI 助手。
- 功能点说明：
  - 部署模式：
    - **本地部署模式**：
      - 适用场景：门店网络不稳定、有数据安全和隐私要求、希望降低长期使用成本的单店环境；
      - 模型要求：支持在本地服务器或边缘设备上部署轻量级大语言模型（如 7B-13B 参数规模），能够满足对话、RAG 检索、意图识别等核心功能；
      - 硬件建议：最低配置为 16GB 内存、支持 GPU 加速（可选，但推荐用于提升响应速度）；
      - 离线能力：本地部署后，核心对话与知识库检索功能可在完全离线状态下运行，报表生成依赖本地数据库；
      - 模型更新：支持通过离线安装包或低频联网方式更新模型版本和知识库内容。
    - **外部调用模式（云端 API）**：
      - 适用场景：门店网络稳定、希望使用更强大的模型能力、无需本地维护基础设施的环境；
      - 调用方式：通过 HTTPS API 调用云端大语言模型服务（如 OpenAI API、Azure OpenAI、国内主流大模型 API 等）；
      - 网络要求：稳定的互联网连接，建议带宽 ≥ 10Mbps，延迟 < 200ms；
      - 数据传输：所有数据传输必须加密（TLS 1.2+），敏感数据在传输前进行脱敏处理；
      - 降级策略：当外部 API 不可用时，自动降级到本地缓存的常见问题答案或提示用户稍后重试。
  - 混合模式（可选）：
    - 支持"本地 + 云端"混合部署：常规对话和检索使用本地模型，复杂分析或需要更强推理能力的任务可选择性调用云端 API；
    - 通过配置中心灵活切换或组合使用两种模式。
  - 配置与管理：
    - 提供配置界面或配置文件，允许管理员选择部署模式、配置 API 端点、设置模型参数（如温度、最大 token 数）；
    - 对于本地部署，提供模型加载状态监控、性能指标（响应时间、GPU 利用率等）和日志查看功能；
    - 对于外部调用，提供 API 调用成功率、平均延迟、费用统计（如有）等监控。
  - 数据隐私与合规：
    - 本地部署模式：所有数据处理在本地完成，不向外部传输任何业务数据或用户问题；
    - 外部调用模式：必须确保调用的云端服务符合数据隐私法规（如 GDPR、《个人信息保护法》），并在用户协议中明确告知；
    - 无论哪种模式，都不得将住客姓名、证件号、订单号等敏感 PII 发送给 AI 模型（关联 801 脱敏规则）。
- 验收标准：
  - 本地部署模式可在完全离线环境下正常运行对话与 RAG 检索功能，响应时间 p95 ≤ 5s；
  - 外部调用模式在网络正常时响应时间 p95 ≤ 3s，API 不可用时能够降级并给出明确提示；
  - 两种模式可通过配置灵活切换，切换后系统功能正常，不出现数据丢失或功能异常；
  - 所有模式下均不泄露未脱敏的 PII 数据。

[801] 审计与脱敏
- 用户故事：作为合规和安全负责人，我需要追溯关键操作与问答行为，知道谁在什么时候对哪些数据做了什么，同时确保在日志和回答中不会泄露住客隐私。
- 功能点说明：
  - 审计范围：
    - 记录以下关键操作：登录/登出、权限变更、知识库文档上传/发布/回滚、报表导出（6xx）、订阅创建/修改/删除（602）、模板分享（502）、越权访问被拦截事件（702）、通过 MCP 或其他接口发起的数据查询异常（9xx）。
  - 审计内容（最小必要）：
    - 每条记录至少包含：时间戳、操作者及角色、租户/门店范围、操作类型、操作对象标识、结果（成功/失败）、错误原因摘要（如有）；
    - 对话相关操作仅记录"问题摘要 + 处理结果类型"（命中知识库/数据查询/兜底等），不保留完整问题文本和原始上下文。
  - 脱敏与最小化：
    - 明确敏感数据范围（住客姓名、手机号、邮箱、证件号、房卡卡号、订单号、证件照片、支付信息等）以及业务敏感信息（内部账号、设备密钥等），按等级配置脱敏/屏蔽规则；
    - 在数据查询与报表接口中，对涉及敏感字段默认不返回，仅在功能明确需要且经过脱敏时才返回（如手机号后 4 位 `138****5678`）；
    - 在 AI 回答生成阶段，对模型输出做敏感模式检测，命中时替换为掩码或提示语；审计记录和监控数据中禁止写入原始敏感信息。
  - 查询、导出与留存：
    - 提供按时间、操作者、操作类型过滤审计记录的能力，仅授权管理员可查询与导出；
    - 审计日志默认留存不少于 90 天，之后可按租户策略归档或删除，对有更高合规要求的租户支持更长留存期。
- 验收标准：核心操作审计日志完整率 100%；抽检回答和日志样本中不出现未脱敏的 PII；脱敏规则及其变更可追溯。

[802] 异常与降级体验
- 用户故事：作为用户，我希望在系统无法正常响应时（查询无结果、报表超时、数据不完整等），能获得清晰的提示和下一步建议，而不是卡住或得到错误答案。
- 功能点说明：
  - 无命中与澄清：
    - 当 RAG 或意图识别无可靠结果时，必须返回明确的无命中提示，而不是"编一个答案"；
    - 提供 2–3 条改写建议或澄清问题，用户点击即可二次检索。
  - 超时与后台处理：
    - 对复杂报表设置统一超时阈值（默认 8 秒，可配置）；
    - 超时时将任务转为后台执行，通过通知告知用户结果可用，结果在限定有效期内可重复查看而无需重算。
  - 部分结果提示：
    - 在上游数据部分不可用时，以明显的"部分结果"标记和说明提示用户；
    - 对缺失比例过高的情况，允许直接提示"数据不完整，建议稍后再试"，而不是给出误导性汇总。
- 验收标准：无命中、超时、部分结果等场景下，用户都能获得清晰的提示与下一步建议；不出现"编造答案"或"静默失败"的情况。

[803] 内容安全护栏 (AI Shield)
- 用户故事：作为管理员，我希望系统能自动拦截恶意输入和不当输出，确保 AI 助手的回答安全、合规且不产生幻觉。
- 功能点说明：
  - 护栏机制（双向拦截）：
    - 为了兼顾安全与合规，系统需在“输入”和“输出”两个环节分别设置护栏：
    - **输入护栏（Input Guardrail）**：在调用大模型生成之前执行。
      - 对象：用户原始提问 + (可选) 检索到的 RAG 上下文。
      - 目的：拦截 Prompt Injection（提示词注入）、恶意指令攻击；防止检索到被污染的知识误导模型。
    - **输出护栏（Output Guardrail）**：在大模型生成回答之后、返回给用户之前执行。
      - 对象：模型生成的最终文本。
      - 目的：拦截幻觉（Hallucination）、未脱敏 PII、不当言论、政治敏感内容。
  - 检测维度：
    - **内容合规性**：检测是否包含暴力、色情、仇恨言论、政治敏感等违规内容（主要针对大模型生成的自由文本）。
    - **指令攻击防御**：检测用户输入是否存在 Prompt Injection（提示词注入）攻击风险，防止模型被诱导输出系统指令。
    - **数据隐私二次校验**：对即将输出的文本进行正则扫描，确保没有未脱敏的 PII（如手机号、身份证号）遗漏。
    - **幻觉与一致性（高级）**：对于数据分析类回答，校验生成的文本摘要是否与结构化数据结果存在明显矛盾（如数据是“上升”，文本说“下降”）。
  - 处置策略：
    - **拦截与阻断**：发现严重违规（如有害内容）时，直接拦截输出，返回通用错误提示（“检测到不当内容，已停止生成”）。
    - **替换与降级**：发现轻微风险或 PII 泄露风险时，自动替换为掩码（`****`）或降级为仅展示结构化数据卡片，不展示分析文本。
    - **审计与告警**：所有触发护栏的拦截行为均需记录高优审计日志，并支持向管理员发送实时告警。
  - 部署适配：
    - **本地模式**：采用轻量级分类模型（如 BERT-tiny）或关键词/正则规则库，保障低延迟。
    - **云端模式**：调用云厂商提供的内容安全 API（Content Safety API）。
- 验收标准：
  - 恶意攻击样本拦截率 ≥ 95%；
  - 敏感隐私数据输出拦截率 100%；
  - 护栏处理延迟 < 200ms（本地）或 < 500ms（云端），不显著影响用户体验。

---

## 9xx 数据接入与集成

[901] 通过 MCP 访问门锁数据与报表
- 用户故事：作为门锁系统的业务用户（前台/运营/经理等），我在使用 AI 助手查询数据或生成报表时，希望它调用门锁系统真实的数据和报表能力（通过 MCP 工具实现），以便结果与现有系统保持一致并提升工作效率。
- 功能点说明：
  1. 协议兼容。
    - 支持 MCP 当前稳定版本，按协议注册资源与工具名称；
    - 实现必要的特征/能力描述，使智能体能够识别并发现可用工具及其参数。
  2. 查询模型。
    - 提供事件、设备、告警等核心查询工具，基于门锁系统已有的查询能力封装，不另起一套逻辑；
    - 工具命名清晰，例如 `events.query`，参数结构与门锁现有数据接口保持一致。
  3. 数据路径一致。
    - MCP 返回的数据与门锁现有 API、报表接口使用相同的数据定义和业务规则；
    - 参数格式尽量与智能报表（4xx/5xx）对齐，降低集成和维护成本。
  4. 安全与限流。
    - MCP 请求需验证身份凭证，复用门锁系统现有账号体系和权限模型（关联 7xx），避免通过固定超级账号访问全量数据；
    - 对 MCP 通道单独设置速率限制，防止被滥用或批量抓取敏感数据（关联 802）；
    - 记录所有 MCP 调用日志，包含调用方、工具名、参数摘要（脱敏）和结果状态，便于审计与排查（关联 801）。
  5. 返回格式与文档。
    - 查询结果以结构化 JSON 返回，每个字段提供类型定义和简要说明；
    - 预先提供完整的工具描述文档（schema、参数说明、示例），便于外部集成和后续维护。
  6. 备注（实现留白）。
    - 可基于现有数据库/服务接口封装 MCP 适配层，避免重复开发查询逻辑；
    - 协议版本兼容和升级节奏由技术团队维护，本 PRD 不做具体方案约束。
- 验收标准：
  - 在不额外直连数据库或编写 SQL 的前提下，模型通过 MCP 工具即可完成 2xx/4xx/5xx/6xx 中描述的数据查询和报表生成场景；
  - 抽检同一问题在 AI 助手回答和对应预置报表/自助报表中的数值一致（在约定的刷新延迟范围内）；
  - 所有 MCP 调用均经过权限校验并有审计记录，限流策略在压测和模拟滥用场景下可稳定生效。


---

## 统一非功能与验收（1.0）
- 性能：对话首响应 p95 ≤ 3s；复杂报表 ≤ 8s。
- 可用性：月度 99.9%；关键路径具备重试与降级。
- 安全：越权 100% 拦截；PII 不出现在答案/日志；数据加密传输/存储。
- 质量：FAQ Top1 可用 ≥ 85%；数据查询解析成功 ≥ 90%；导出成功 ≥ 99%。
- 合规：日志留存 90 天；最小化收集；可删除/可留存策略到位。

参考
- 数据模型：`docs/DataModel.md`
- 报表口径：`docs/ReportingSpecs.md`