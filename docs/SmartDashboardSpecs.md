# 智能仪表盘模块规格文档

> 版本：v1.0  
> 日期：2025-11-28  
> 状态：MVP 草案

---

## 1. 模块概述

### 1.1 定位

智能仪表盘是门锁系统的独立功能模块，为不同角色的用户提供数据可视化与智能洞察能力。区别于传统报表的"被动查询"模式，智能仪表盘强调：

- **主动发现问题**：通过数据聚合与异常检测，自动识别需要关注的事项
- **智能归因分析**：不仅展示"是什么"，还分析"为什么"
- **角色定制视图**：不同角色看到与其职责相关的数据和洞察

### 1.2 目标用户

| 角色 | 对应仪表盘 | 核心诉求 |
|------|------------|----------|
| 安全主管/值班经理 | 安全监控 | 风险预警、异常行为发现、事后追溯 |
| 运营经理/店长 | 运营分析 | 经营概览、效率分析、趋势洞察 |
| 工程部/运维人员 | 设备运维 | 设备健康、故障定位、预防性维护 |
| 前台接待员 | 前台助手 | 实时房态、快速响应、服务预判 |

### 1.3 入口

在门锁系统主菜单中新增"**智能分析**"入口，进入后可切换查看四个仪表盘。用户可根据权限看到对应的仪表盘（如前台人员默认只能看"前台助手"）。

---

## 2. 通用设计规范

### 2.1 页面结构

每个仪表盘页面采用统一布局：

```
┌─────────────────────────────────────────────────────────┐
│  [仪表盘名称]                    最后更新：14:32:01     │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │  💡 智能洞察                                      │    │
│  │  • 洞察要点 1                                    │    │
│  │  • 洞察要点 2                                    │    │
│  │  • 洞察要点 3                                    │    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐           │
│  │  模块 1   │  │  模块 2   │  │  模块 3   │           │
│  │           │  │           │  │           │           │
│  └───────────┘  └───────────┘  └───────────┘           │
│  ┌───────────────────┐  ┌───────────────────┐          │
│  │      模块 4       │  │      模块 5       │          │
│  │                   │  │                   │          │
│  └───────────────────┘  └───────────────────┘          │
└─────────────────────────────────────────────────────────┘
```

### 2.2 智能洞察卡片

**位置**：仪表盘顶部固定区域

**内容**：
- 显示 2-3 条 AI 生成的洞察要点
- 每条洞察包含：数据摘要 + 归因分析
- 不包含具体行动建议（避免误导）

**生成机制**：
- 采用混合模式：先显示缓存内容，后台异步刷新
- 有新洞察时，卡片右上角显示"有新内容"提示，用户可点击刷新
- 缓存有效期：5 分钟

**降级策略**：
- AI 生成失败或超时（>5秒）时，显示基于规则的简单统计
- 示例："今日告警 3 条，低电量设备 5 台，离线设备 2 台"

**洞察示例**：
```
💡 智能洞察
• 3楼本周挂失 4 张卡，高于全店平均 300%，集中在 3201-3205 房间
• 网关 GW-03 今日离线 3 次，影响 8 楼 12 间客房的门锁通信
• 操作员"张三"今日发卡耗时平均 4.2 分钟，高于团队均值 50%
```

### 2.3 数据刷新

- **刷新频率**：约 1 分钟自动刷新
- **刷新方式**：静默刷新，数字直接更新
- **更新时间**：右上角显示"最后更新：HH:mm:ss"
- **手动刷新**：支持用户手动点击刷新按钮

### 2.4 下钻交互

- **触发方式**：点击模块中的数据项
- **展示形式**：弹窗（Modal）
- **弹窗内容**：明细列表
- **筛选功能**：支持按时间范围、楼层、状态筛选
- **导出功能**：支持导出为 CSV 格式

### 2.5 告警阈值

MVP 版本采用系统预设默认值：

| 告警项 | 默认阈值 |
|--------|----------|
| 敏感卡单日使用次数 | ≥ 5 次 |
| 设备离线率 | ≥ 5% |
| 低电量设备数 | ≥ 3 台 |
| 鉴权失败次数（同一卡） | ≥ 3 次 |
| 任务队列积压 | ≥ 10 条 |

后续版本开放给酒店管理员配置。

---

## 3. 仪表盘详细设计

### 3.1 安全监控

**目标用户**：安全主管、值班经理

**核心价值**：实时预警 + 异常模式识别 + 关联分析

#### 模块列表

| 模块 | 内容 | 组件样式 | 数据来源 |
|------|------|----------|----------|
| **敏感卡监控** | 总卡/应急卡/楼栋卡使用情况 | 表格（卡类型、今日使用次数、最近使用人、最近使用时间）+ 超阈值行高亮 | `other_make_card_record` |
| **夜间异常活动** | 0:00-6:00 的开门记录 | 时间轴列表（时间、房号、开门方式、操作人）+ 异常标签 | `sys_log` 按时段筛选 |
| **鉴权失败分析** | 开门失败统计与归因 | 数字卡片（今日失败总数）+ 分类占比饼图 + 明细列表 | `sys_log` + `sys_event` |
| **权限变更追踪** | 员工权限调整记录 | 时间线（操作时间、操作人、被操作人、变更内容）+ 异常标记 | `operator_power_record` |
| **挂失热点分析** | 卡片挂失统计与分布 | 数字（本周/本月）+ 楼层分布柱状图 | `guest_make_card_record.lost_card_date` |

#### 智能洞察侧重

- 风险预警：敏感卡异常使用、非正常时段活动
- 异常模式：某区域挂失率异常、连续鉴权失败
- 归因分析：失败原因分类、异常集中区域

#### 洞察示例

```
💡 智能洞察
• 总卡"MC-001"今日使用 8 次，主要集中在 3 楼（6 次），超出日常使用频率
• 凌晨 2:00-4:00 有 5 条非员工卡开门记录，均为 1205 房间，请核实是否正常
• 3 楼本周挂失 4 张卡，占全店 67%，集中在 3201-3205 房间区域
```

#### 异常标记规则

| 场景 | 标记 |
|------|------|
| 敏感卡单日使用 ≥5 次 | 🔴 高亮行 |
| 空房被开门 | 🏷️ "空房开门"标签 |
| 非排班时段操作 | 🏷️ "非工作时段"标签 |
| 同一卡连续失败 ≥3 次 | 🏷️ "疑似异常卡"标签 |
| 非工作时间改权限 | 🔴 红色标记 |

---

### 3.2 运营分析

**目标用户**：运营经理、店长

**核心价值**：对比分析 + 趋势洞察 + 效率瓶颈识别

#### 模块列表

| 模块 | 内容 | 组件样式 | 数据来源 |
|------|------|----------|----------|
| **今日经营指标** | 入住率、发卡量、异常数、设备在线率 | 4 个指标卡片（数字 + 同比/环比箭头） | 多表聚合 |
| **7日趋势** | 入住量、异常事件变化趋势 | 双 Y 轴图（柱状图 + 折线图）+ 异常点标记 | 历史数据按天聚合 |
| **发卡效率** | 各操作员发卡量排名 | 横向柱状图 + 效率低的人标黄 | `guest_make_card_record.operator` |
| **房型分析** | 各房型入住率对比 | 表格（房型、房间数、在住数、入住率%）+ 低效房型标黄 | `room_info.room_type` + `bill_rooms` |
| **异常分类** | 事件类型占比分布 | 环形图 + 图例列表 + 趋势箭头 | `sys_log` + `sys_event` |

#### 智能洞察侧重

- 趋势变化：同比/环比变化、连续上升/下降
- 效率分析：发卡耗时、人员效率对比
- 结构分析：房型利用率差异、异常类型分布

#### 洞察示例

```
💡 智能洞察
• 今日入住率 78%，较昨日下降 5%，主要是标准间入住减少（-8 间）
• 本周异常事件较上周增加 23%，主要增量来自"低电量告警"（+15 起）
• 操作员"李四"平均发卡耗时 5.1 分钟，高于团队均值 2.3 分钟
```

#### 指标计算口径

| 指标 | 计算公式 | 数据来源 |
|------|----------|----------|
| 入住率 | 在住房间数 / 可用房间总数 × 100% | `room_info.status_code = 1` |
| 今日发卡量 | 当日发卡记录数 | `guest_make_card_record.make_card_date` |
| 异常事件数 | 当日非成功事件数 | `sys_log` + `sys_event.event_code != 0` |
| 设备在线率 | 在线设备数 / 设备总数 × 100% | `gw_sub_device.status` |

---

### 3.3 设备运维

**目标用户**：工程部、运维人员

**核心价值**：预测性维护 + 故障根因定位 + 影响范围评估

#### 模块列表

| 模块 | 内容 | 组件样式 | 数据来源 |
|------|------|----------|----------|
| **设备健康概览** | 在线/离线/告警设备统计 | 健康评分仪表盘（0-100分）+ 三色数字卡片 | `gw_sub_device.status` |
| **低电量预警** | 需更换电池的门锁列表 | 表格（房号、楼层、最近告警时间、预计剩余天数）+ 紧急排前 | `sys_log` event_code=31 |
| **网关状态** | 各网关运行情况 | 卡片网格（状态灯、名称、设备数、信号强度）+ 异常卡片高亮 | `gateway_info` + `gw_sub_device` |
| **楼层分布图** | 按楼层的设备健康分布 | 横向堆叠条形图（绿=正常/黄=告警/红=离线） | `room_info.floor_code` + 设备聚合 |
| **任务队列监控** | Zigbee 指令执行情况 | 三个数字（待发送/执行中/失败）+ 异常队列列表 | `ZB_Task_Queue` |

#### 智能洞察侧重

- 健康预警：离线率变化、低电量预测
- 根因分析：故障是网关问题还是门锁问题
- 影响评估：故障影响哪些房间、是否有在住客人

#### 洞察示例

```
💡 智能洞察
• 设备健康评分 82 分，较昨日下降 5 分，主要因 3 楼离线设备增加
• 网关 GW-03 今日离线 2 次，挂载的 15 台设备受影响，其中 8 间有在住客人
• 预计未来 7 天有 6 把锁需更换电池，集中在 5 楼（4 把）
```

#### 健康评分计算

```
健康评分 = 在线率 × 40 + (100 - 告警率) × 30 + (100 - 任务失败率) × 30

其中：
- 在线率 = 在线设备数 / 总设备数 × 100
- 告警率 = 告警设备数 / 总设备数 × 100
- 任务失败率 = 失败任务数 / 总任务数 × 100
```

#### 低电量预测逻辑

基于历史告警间隔估算剩余天数：
- 取该设备过去 3 次低电量告警的平均间隔
- 如无历史数据，使用全店平均值（默认 180 天）
- 剩余天数 = 平均间隔 - (当前日期 - 最近告警日期)

---

### 3.4 前台助手

**目标用户**：前台接待员

**核心价值**：主动提醒 + 快速响应 + 服务预判

#### 模块列表

| 模块 | 内容 | 组件样式 | 数据来源 |
|------|------|----------|----------|
| **实时房态** | 在住/空净/脏房/维修数量 | 4 个数字卡片 + 环形占比图 + 待跟进角标 | `room_info.status_code` |
| **到期提醒** | 今日应退/即将到期房间 | 列表（房号、预计退房时间、状态）+ 紧急程度颜色 | `bill_rooms.plan_out_date` |
| **开门异常** | 最近 1 小时开门失败 | 滚动列表（时间、房号、失败原因）+ 失败次数角标 | `sys_log` + `sys_event` |
| **今日发卡进度** | 发卡完成情况 | 进度条（已发卡/预订总数）+ 待办理列表 | `guest_make_card_record` + `bill_rooms` |
| **服务预判** | 可能需要关注的房间 | 提示卡片（房号、原因、建议）| 综合分析 |

#### 智能洞察侧重

- 待办提醒：到期未退、待发卡
- 服务预判：开门失败可能导致投诉
- 异常关注：同一房间多次失败

#### 洞察示例

```
💡 智能洞察
• 2101 房间过去 30 分钟开门失败 3 次，客人可能需要帮助
• 1205 房间已超过退房时间 2 小时，卡片仍有效，建议确认是否续住
• 今日预订 15 间，已发卡 12 间，还有 3 间待办理（预计 14:00 前入住）
```

#### 紧急程度颜色

| 状态 | 颜色 | 说明 |
|------|------|------|
| 已过期 | 🔴 红色 | 已超过退房时间 |
| 1 小时内到期 | 🟡 黄色 | 即将到期 |
| 今日到期 | 🔵 蓝色 | 今日需退房 |
| 正常 | ⚪ 灰色 | 无需关注 |

#### 服务预判触发规则

| 触发条件 | 预判提示 |
|----------|----------|
| 同一房间 30 分钟内开门失败 ≥3 次 | "客人可能遇到开门问题，建议主动联系" |
| 超过退房时间 2 小时未退卡 | "建议确认是否续住" |
| VIP 房型开门失败 | "VIP 客人可能需要优先关注" |

---

## 4. 数据来源映射

### 4.1 核心表依赖

| 数据维度 | 主表 | 关联表 |
|----------|------|--------|
| 房间状态 | `room_info` | `room_type`, `bill_rooms` |
| 开门事件 | `sys_log` | `sys_event` |
| 发卡记录 | `guest_make_card_record` | `bill_rooms`, `employees` |
| 敏感卡使用 | `other_make_card_record` | `employees` |
| 设备状态 | `gw_sub_device` | `gateway_info`, `room_info` |
| 任务队列 | `ZB_Task_Queue` | `gateway_info` |
| 权限变更 | `operator_power_record` | `employees` |

### 4.2 关键字段说明

#### room_info.status_code 房间状态

| 值 | 含义 |
|----|------|
| 0 | 空净 |
| 1 | 在住 |
| 2 | 待维修 |
| 3 | 脏房 |
| 4 | Zigbee 离线 |
| 5 | 低电压 |

#### sys_event.event_type_code 事件类型

| 值 | 含义 |
|----|------|
| 1 | 访问事件（Access events） |
| 2 | 状态事件（Status events） |
| 3 | 错误事件（Error events） |

#### gw_sub_device.status 设备状态

| 值 | 含义 |
|----|------|
| 0 | 离线 |
| 1 | 在线 |

#### ZB_Task_Queue.status 任务状态

| 值 | 含义 |
|----|------|
| 0 | 待发送 |
| 1 | 已发送/执行中 |
| 2 | 已确认/成功 |
| -1 | 失败 |

---

## 5. AI 洞察生成规范

### 5.1 输入数据

AI 洞察生成需要以下聚合数据作为输入：

```json
{
  "dashboard_type": "security|operations|engineering|frontdesk",
  "timestamp": "2025-11-28T14:30:00+08:00",
  "metrics": {
    // 根据仪表盘类型不同，提供不同的指标数据
  },
  "anomalies": [
    // 检测到的异常列表
  ],
  "comparisons": {
    // 同比/环比数据
  }
}
```

### 5.2 输出格式

```json
{
  "insights": [
    {
      "priority": 1,
      "content": "洞察内容文本",
      "type": "warning|info|trend",
      "related_module": "模块名称"
    }
  ],
  "generated_at": "2025-11-28T14:30:05+08:00"
}
```

### 5.3 洞察生成 Prompt 模板

```
你是一个酒店门锁系统的数据分析助手。请根据以下数据生成 2-3 条洞察要点。

要求：
1. 每条洞察包含具体数据和归因分析
2. 优先输出异常和风险相关的洞察
3. 使用简洁的中文表达
4. 不要给出具体行动建议
5. 数字要准确，来源于提供的数据

当前仪表盘：{dashboard_type}
数据快照：
{metrics_json}

检测到的异常：
{anomalies_json}

请生成洞察：
```

### 5.4 降级规则模板

当 AI 生成失败时，使用以下模板生成基础洞察：

**安全监控**：
```
• 今日敏感卡使用 {sensitive_card_count} 次，{alert_status}
• 夜间活动记录 {night_activity_count} 条
• 鉴权失败 {auth_fail_count} 次
```

**运营分析**：
```
• 当前入住率 {occupancy_rate}%，{trend}
• 今日发卡 {card_issued} 张
• 异常事件 {anomaly_count} 起
```

**设备运维**：
```
• 设备在线率 {online_rate}%
• 低电量设备 {low_battery_count} 台
• 任务队列积压 {pending_tasks} 条
```

**前台助手**：
```
• 当前在住 {occupied} 间，空房 {vacant} 间
• 今日待退房 {checkout_due} 间
• 最近 1 小时开门异常 {recent_failures} 次
```

---

## 6. 接口设计

### 6.1 获取仪表盘数据

**请求**：
```
GET /api/smart-dashboard/{dashboard_type}
```

**参数**：
- `dashboard_type`: security | operations | engineering | frontdesk

**响应**：
```json
{
  "code": 0,
  "data": {
    "last_updated": "2025-11-28T14:32:01+08:00",
    "insights": {
      "items": [...],
      "is_cached": true,
      "generated_at": "2025-11-28T14:30:00+08:00"
    },
    "modules": {
      "module_1": {...},
      "module_2": {...}
    }
  }
}
```

### 6.2 刷新洞察

**请求**：
```
POST /api/smart-dashboard/{dashboard_type}/refresh-insights
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "insights": [...],
    "generated_at": "2025-11-28T14:35:00+08:00"
  }
}
```

### 6.3 获取明细数据（下钻）

**请求**：
```
GET /api/smart-dashboard/{dashboard_type}/detail/{module_id}
```

**参数**：
- `time_range`: today | yesterday | week | month | custom
- `start_date`: 自定义开始日期（time_range=custom 时必填）
- `end_date`: 自定义结束日期
- `floor`: 楼层筛选
- `status`: 状态筛选
- `page`: 页码
- `page_size`: 每页条数

**响应**：
```json
{
  "code": 0,
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "items": [...]
  }
}
```

### 6.4 导出明细

**请求**：
```
POST /api/smart-dashboard/{dashboard_type}/export/{module_id}
```

**参数**：同明细数据接口

**响应**：
- Content-Type: text/csv
- Content-Disposition: attachment; filename="export_20251128.csv"

---

## 7. 权限控制

### 7.1 仪表盘访问权限

| 角色 | 安全监控 | 运营分析 | 设备运维 | 前台助手 |
|------|----------|----------|----------|----------|
| 管理员 | ✅ | ✅ | ✅ | ✅ |
| 店长/经理 | ✅ | ✅ | ✅ | ✅ |
| 安全主管 | ✅ | ❌ | ❌ | ❌ |
| 运营人员 | ❌ | ✅ | ❌ | ❌ |
| 工程人员 | ❌ | ❌ | ✅ | ❌ |
| 前台人员 | ❌ | ❌ | ❌ | ✅ |

### 7.2 数据范围权限

- 所有数据查询需遵循用户的数据范围权限（楼层/区域限制）
- 导出功能需记录审计日志

---

## 8. 非功能需求

### 8.1 性能

| 指标 | 要求 |
|------|------|
| 仪表盘首屏加载 | ≤ 2 秒 |
| 数据刷新 | ≤ 1 秒 |
| AI 洞察生成 | ≤ 5 秒（超时走降级） |
| 明细弹窗加载 | ≤ 1 秒 |
| 导出文件生成 | ≤ 10 秒（1000 条以内） |

### 8.2 数据刷新

| 数据类型 | 刷新频率 |
|----------|----------|
| 实时指标（房态、在线率） | 1 分钟 |
| 统计数据（趋势、排名） | 5 分钟 |
| AI 洞察 | 5 分钟缓存 + 手动刷新 |

### 8.3 兼容性

- 浏览器：Chrome 80+、Edge 80+、Safari 13+
- 分辨率：最小支持 1366×768
- MVP 版本暂不支持移动端

---

## 9. 版本规划

### MVP（v1.0）

- ✅ 4 个仪表盘基础功能
- ✅ 固定布局
- ✅ AI 洞察生成（带降级）
- ✅ 一层下钻明细
- ✅ 基础筛选与导出
- ✅ 系统预设告警阈值

### v1.1

- 告警阈值可配置
- 仪表盘间联动提示
- 更丰富的下钻层级

### v2.0

- 可拖拽自定义布局
- 多店/集团数据对比
- 移动端适配
- AI 行动建议

---

## 附录 A：组件样式规范

### A.1 数字卡片

```
┌─────────────────┐
│  📊 入住率      │
│     78%        │  ← 主数字（大号字体）
│   ↑ 5%        │  ← 同比变化（绿涨红跌）
└─────────────────┘
```

### A.2 表格

```
┌──────┬──────┬──────────┬──────────┐
│ 房号 │ 楼层 │ 告警时间  │ 预计剩余  │  ← 表头
├──────┼──────┼──────────┼──────────┤
│ 3201 │ 3F   │ 14:20    │ 3 天     │  ← 紧急行（红色背景）
│ 5102 │ 5F   │ 10:15    │ 7 天     │
│ ...  │      │          │          │
└──────┴──────┴──────────┴──────────┘
        [筛选] [导出 CSV]              ← 操作按钮
```

### A.3 时间轴

```
14:32 ● 总卡 MC-001 开门 - 3205 房间 - 张三
      │
14:28 ● 应急卡 EC-002 开门 - 1101 房间 - 李四  🔴 异常标记
      │
14:15 ● 楼栋卡 BC-001 开门 - 大堂 - 王五
```

### A.4 环形图

```
      ╭───────╮
    ╱    78%   ╲     在住: 78 间
   │   在住    │     空净: 15 间
    ╲          ╱     脏房: 5 间
      ╰───────╯      维修: 2 间
```

### A.5 健康评分仪表盘

```
         85
    ╭─────────╮
   ╱  良好     ╲
  ───────●──────   ← 指针
  0    50    100
```

---

## 附录 B：错误码

| 错误码 | 说明 |
|--------|------|
| DASHBOARD_001 | 仪表盘类型不存在 |
| DASHBOARD_002 | 无权限访问该仪表盘 |
| DASHBOARD_003 | 数据加载超时 |
| DASHBOARD_004 | AI 洞察生成失败（已降级） |
| DASHBOARD_005 | 导出数据量超限 |
| DASHBOARD_006 | 筛选参数无效 |

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v1.0 | 2025-11-28 | 初版发布，MVP 功能定义 |
