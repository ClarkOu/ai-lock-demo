# AI门锁系统 - 需求梳理

---

## 一、全局与入口

### 1.1 对话入口

**S-01**
> 作为门锁系统管理用户，
> 我希望随时打开AI助手，
> 以便我快速发起对话或任务请求

**功能点说明：**

**1. 入口形态与位置**
- （1）在现有门锁系统所有业务页面的右下角，常驻一个AI助手入口（悬浮按钮），不遮挡关键操作区域；
- （2）悬浮按钮点击后展开主对话面板（弹窗），再次点击可最小化回到按钮形态；

**2. 打开方式与快捷键**
- （1）点击入口按钮可打开/关闭会话面板；

**3. 最大化形态**
- （1）打开浮窗入口，小窗口便于日常QA。点击小窗口的右上角，可放大展开对话窗口以获得完整的功能支持；
- （2）放大后的对话窗口，可通过点击小窗口按钮，回到小窗口形态；
- （3）点击"X"，对话窗口关闭，AI助手回到浮窗小球状态。

### 1.2 通知入口（铃铛）
> 作为门锁系统管理用户，
> 我希望在系统各页面都能快速查看“最近通知/告警提醒”，
> 以便我及时处理异常并在需要时前往对应模块。

**功能点说明：**

**1. 入口与角标**
- （1）在系统页面顶部栏右侧提供“铃铛”入口（与系统状态提示并列）；
- （2）铃铛角标显示“未读通知数”；当未读数为 0 时角标隐藏。

**2. 通知面板（最近通知）**
- （1）点击铃铛打开通知面板，默认展示“未读”列表；支持切换“未读/全部”；
- （2）每条通知包含：所属模块（数据总览/前厅运营/安全运维）、等级（紧急/警告/提示）、标题、时间与简要建议；
- （3）支持“一键全部已读”。

**3. 已读规则（本版本）**
- （1）仅当用户打开某条通知的“详情”时，才将该条标记为已读（点击打开面板不改变已读状态）。

**4. 跳转与收起行为**
- （1）点击某条通知后：默认弹出“通知详情”；在详情中可选择“前往”对应的智能看板页面/模块；
- （2）当用户切换模块/页面或继续浏览页面内容时，通知面板自动收起，避免遮挡业务视图。

**5. 通知设置（邮件为主）**
- （1）通知面板提供“通知设置”入口，用于配置邮件通知的接收人（To/Cc）与接收等级（紧急/警告/提示）；
- （2）本版本不依赖值班表，默认以固定邮箱组/群组邮箱作为收件人配置方式。

---

## 二、对话与问答

### 2.1 会话与上下文管理

**S-02**
> 作为用户，
> 我希望可以快速开启对话，历史记录自动保留但不会干扰新问题，
> 以便我高效完成单次任务

**功能点说明：**

**1. 新建会话**
- （1）用户点击AI入口按钮时，直接进入对话界面；
- （2）若距上次对话不超过10分钟，延续上下文；否则视为新会话；
- （3）用户可点击输入框上方的"开启新对话"按钮，主动断开上下文。

**2. 断开会话**
- （1）当用户超过10分钟无交互后，当前对话自动结束；
- （2）下次提问时，对话区域显示分隔符"——以下为新会话——"；
- （3）新对话不关联之前的上下文，但历史记录仍可向上滚动查看；
- （4）若用户因门锁系统自动退出登录（系统设置的无操作超时），重新登录后会话回到默认状态，视为全新会话。

**3. 历史记录**
- （1）对话历史按时间倒序保留，最多保留最近30天/500条消息；
- （2）不同会话之间以分隔符区分；
- （3）超出保留期限的历史自动被清理。

**4. 上下文管理**
- （1）系统在构造prompt时会带上当前会话的历史消息，作为上下文；
- （2）如果总Token超过模型上下文限制，调用摘要模型压缩早期对话（具体模型待开发过程中调试）；
- （3）摘要内容对用户不可见，包括：用户意图、关键约束、已确认结论、涉及的数据范围等；
- （4）若摘要失败（如模型调用异常等），当前窗口仍可继续对话，需要记录日志以便后续排查。

### 2.2 意图识别

**S-03**
> 作为用户，
> 我希望与AI对话时，AI能够识别我的咨询意图，按照既定场景进行合适回答，
> 以便我减少对齐操作，优化体验

**功能点说明：**

**1. 意图类别**
此MVP版本支持至少一级意图：
- （1）FAQ/规则/操作指南/SOP
- （2）数据查询
- （3）闲聊/非业务类

**2. 分类器输出**
- （1）对每条用户消息，进行意图识别模块化输出"一级意图类型、置信度值、其他结构化信息（如时间、对象等）"；
- （2）当置信度高于（0.7）时，直接按识别结果进行分流；
- （3）当置信度低于等于（0.7）时，AI发起澄清提问以确认意图。若用户仍未清晰意图，则优先触发知识库进行回答。

**3. 分流逻辑**
- （1）FAQ类，走RAG，不调用数据服务；
- （2）数据查询，走结构化查询流程；
- （3）闲聊/非业务类，提示词限制回答。

**4. /指令兜底**
预置slash command，允许用户直接使用"/+指令"的方式手动分流：
- `/faq` - 强制走知识库问答
- `/data` - 强制走数据查询
- `/chat` - 闲聊模式
- `/diagnose` - 打开门卡诊断工具（Canvas 模式）
- `/report` - 打开报告生成工具

**验收标准：**
- 意图识别准确率

### 2.3 RAG检索引用

**S-04**
> 作为用户，
> 我希望答案有明确来源引用，
> 以便我核查回答真实性

**功能点说明：**

**1. 检索流程**
- TopK等阈值技术定。

**2. 上下文构成与答案生成**
- （1）**拼接**：将3-5段检索到的内容按文档与章节顺序拼接，作为LLM的知识上下文；
- （2）**提示词**：此场景下，只能基于给定上下文回答，不能凭空编造。对于每条关键结论，尽量引用至少一个来源段落；
- （3）**引用标注格式**：在回答末尾列出引用列表：
  - 文档标题
  - 版本号/生效日期（若有）
  - 段落标题或所在章节
  - 页码
- （4）**无命中兜底**：当所有结果相似度较低时：
  - 不生成具体回答内容，返回"未检索到可靠依据"之类的提示；
  - 同时列出若干相近的知识库文档标题作为建议链接；
  - 提示用户可以提供更具体的关键词。
- （5）**埋点记录**：记录检索命中率、相似度、人工反馈，用于后续调优。

**验收标准：**
- 引用覆盖率 ≥ 95%
- 错误引用 ≤ 1%

### 2.4 数据查询

**S-05**
> 作为IT用户，
> 我希望用自然语言描述条件，AI生成数据查询结果，
> 以便我快速获取信息进行故障排查等安排

**功能点说明：**

**1. 询问**
- （1）用户用自然语言输入查询数据意图的问题，如："查询今日门锁访问数据？"
- （2）AI识别意图，并提取查询所需条件。通过调用门锁系统数据库的MCP接口，生成查询数据语句并读取数据库，获得结构化数据；
- （3）结构化查询结果传入LLM，生成最终输出回答。

**2. 限流**
- 性能由技术把控。

**3. 展示**
- 考虑到对话框展示空间有限，查询结果以总结性的文本或表格表示，若需要详细数据指引用户到数据看板查看。

**验收标准：**
- 成功率

### 2.5 指令模版/快捷提示

**S-06**
> 作为用户，
> 我希望能够快速上手常见问题与报表，
> 以便我便捷到达常用问题的答案

**功能点说明：**

**1. 位置**
- 从浮窗球状态打开HostPilot的聊天界面或在完整窗口创建新聊天，输入框上方区域展示若干条快捷指令。

**2. 快捷指令生成**
- 快捷指令模版由AI根据用户常问问题或知识库内容生成。

**3. 使用方式**
- 用户点击快捷指令，快速在输入框中输入prompt并立刻发送该指令进行咨询。

### 2.6 硬件诊断（Artifacts 模式）

**S-06b**
> 作为前台/值班人员，
> 我希望在客人反馈"门卡打不开门"时，能够快速定位问题原因并一键解决，
> 以便我高效处理客诉，减少等待时间。

**功能点说明：**

**1. 交互模式：双区布局（识别区 + 对话区）**
- （1）当用户触发硬件诊断类工具时，HostPilot 窗口向左扩展，形成左右分栏布局：
- （2）**左侧（识别区）**：用于展示可视化的硬件交互界面，包括动画引导、实时状态、诊断结果；
- （3）**右侧（对话区）**：保持对话流，AI 继续以对话形式解释、确认、接受用户指令；
- （4）诊断完成后，用户可手动关闭识别区，或 AI 在任务结束后自动收起，恢复为单栏对话模式。

**2. 入口设计：输入框 "+" 按钮**
- （1）**输入框工具按钮**：在输入框左侧设置 **+** 按钮，点击后弹出工具菜单；
- （2）**菜单内容**（显示已有快捷工具）：
  - 门卡诊断
  - （后续可扩展更多工具）
- （3）**交互细节**：
  - 点击菜单项：触发对应功能，菜单自动收起；
  - 点击菜单外区域：菜单自动收起；

**3. 识别区状态流转（三步骤）**

**步骤一：待机引导**
- （1）显示拟物化的"制卡机感应区"动画示意图；
- （2）文字提示："请将门卡放置在制卡机上"；
- （3）同时在聊天区，AI 发送消息引导用户操作。

**步骤二：读取与分析**
- （1）当制卡机检测到卡片，识别区动画切换为"扫描/数据流"效果；
- （2）后台自动执行诊断逻辑，依次检查：
  - 读取卡片；
  - 查询卡片状态：有效期、是否挂失、是否禁用；
  - 查询关联房间状态；
  - 查询门锁设备状态：在线状态、电量、信号强度；
  - 查询下发任务状态：发卡指令是否同步成功；
- （3）对话区域显示"正在分析..."，不打断用户观看动画。

**步骤三：结果展示**
- （1）识别区定格为诊断结果卡片：
  - 顶部：状态（红=异常 / 黄=警告 / 绿=正常）+ 分析结果（如“已过期”、“门锁离线”）；
  - 中部：关键信息摘要（房号、卡类型、有效期、设备状态等）；
  - 底部：操作按钮【重新分析】；
- （2）对话区同步输出 AI 总结（如，问题原因、判断依据、处理建议）。

**4. Agent诊断能力**
- （1）AI 通过系统接口获取卡片状态、设备状态、任务队列等数据；
- （2）AI 根据返回数据自主分析问题原因，输出最可能原因及对应建议操作；

**5. 日志与追溯**
- （1）诊断记录写入系统日志，便于问题追溯。

**6. 权限与安全**
- （1）默认仅限前台及以上角色使用硬件诊断功能；
- （2）涉及"员工卡/总卡/应急卡"的诊断结果，需注意信息敏感性；
- （3）所有诊断留痕（操作人、时间、卡号、诊断结果）。

**验收标准：**
- 从放卡到出结果时长 ≤ 3 秒（常规网络环境）；
- 诊断准确率 ≥ 95%（基于规则覆盖的场景）。

---

## 三、智能报表

### 3.0 智能看板总览

**S-07**
> 作为系统管理员/酒店管理层，
> 我希望快速了解门锁系统整体运行状态和关键指标，发现需要重点关注的问题区域，
> 以便做出及时决策和资源调配

**功能点说明：**

**1. 入口与布局**
- （1）在"智能看板"模块中，总览为第一个 Tab 页（默认首页）；
- （2）页面分为三个区块：AI 智能诊断中心、运营效率透视、24 小时安全态势；
- （3）三个区块垂直排列，一屏显示完整内容。

**2. AI 智能诊断中心**
- （1）基于门锁系统数据自动检测异常，按严重程度分为三类展示；
- （2）**紧急关注类**（需立即处理）：
  - 飞房检测：房间无有效宾客卡（卡已过期或已退房）的情况下被开门，排除员工卡/管理卡开门；==【需开门事件数据】==
  - 员工深夜异常开门：员工卡在 00:00-06:00 期间开门，且开启的是在住房间（有有效宾客卡）；==【需开门事件数据】==
  - 员工短时多房访问：同一员工卡在 1 小时内开启 ≥ 5 间不同房间；==【需开门事件数据】==
  - 敏感卡异常使用：总卡/应急卡/楼栋卡单日使用次数 ≥ 5 次；==【需开门事件数据】==
  - 连续鉴权失败：同一张卡在同一门锁连续鉴权失败 ≥ 3 次；==【需开门事件数据】==
- （3）**待处理类**（需跟进但不紧急）：
  - 换卡频繁：同一房间在入住期间换卡次数 ≥ 3 次；
  - 退房延迟：卡已到期超过 2 小时但未办理退房（无新卡发放）；
  - 门未关超时：门开启状态持续超过 5 分钟（需门磁传感器支持）；==【需门磁状态数据】==
- （4）**建议优化类**（可改进项）：
  - 电量预警：设备电量 ≤ 20%；
  - 信号弱：设备信号强度低于阈值，通信成功率 < 95%；
  - 设备离线：设备离线超过 30 分钟；
- （5）三张卡片分别对应三个类别，每张卡片显示分类名称、问题数量、最典型的问题描述；
- （6）点击卡片展开详情弹窗，列表展示该分类下所有问题，包含问题标题、发生时间、涉及对象、问题详情、建议操作；
- （7）点击单条问题可跳转至安全运维智能体的对应事件详情。

**3. 运营效率透视**
- （1）展示 4 个核心运营效率指标，每个指标包含当前值、对比值、智能洞察；
- （2）**退房→空净 平均耗时**：从客人退房到房间清洁完成的平均时间（分钟），显示与上周对比；
- （3）**入住→首次开门 平均间隔**：从发卡入住到客人第一次开门的平均时间（分钟），反映客人找房体验；
- （4）**门未关告警 平均响应**：告警产生到处理完成的平均时间（分钟），显示与行业标准对比；
- （5）**超时退房 占比**：超过12:00退房的房间占比，显示与上周对比；
- （6）每个指标卡片显示智能洞察/建议，点击可跳转至对应详情页面。

**4. 24 小时安全态势** ==【整体依赖开门事件数据】==
- （1）时间轴可视化展示过去 24 小时（从当前时间往前推 24 小时）的安全事件；
- （2）**异常访问类**（红色标记）：
  - 飞房开门；==【需开门事件数据】==
  - 员工深夜异常开门；==【需开门事件数据】==
  - 员工短时多房访问；==【需开门事件数据】==
  - 连续鉴权失败；==【需开门事件数据】==
  - 敏感卡使用（总卡/应急卡/楼栋卡每次使用都记录）；==【需开门事件数据】==
- （3）**门状态异常类**（橙色标记）：
  - 门未关超时（开启超过 5 分钟）；==【需门磁状态数据】==
  - 非正常时段开门（00:00-06:00 期间的开门记录，排除正常入住/退房）；==【需开门事件数据】==
- （4）横轴代表 24 小时，当前时间用竖线标记并实时移动；
- （5）事件点按发生时间定位在轴上，不同类型用不同颜色区分；
- （6）鼠标悬停事件点显示详情：事件时间、涉及房间/人员、事件描述；
- （7）点击事件点可跳转至安全运维智能体对应事件详情。

**5. 数据更新**
- （1）AI 诊断中心：每 30 秒自动刷新检测结果；
- （2）运营效率透视：每 1 分钟自动刷新指标数据；
- （3）24 小时安全态势：当前时间线每秒更新，事件数据每 30 秒刷新；
- （4）页面提供手动刷新按钮，点击后立即刷新所有数据。

**6. 权限控制**
- （1）具有"智能看板"权限的用户可访问；
- （2）总览页面作为默认首页，向下兼容各角色（安全/运营/运维/前台）的查看权限。

### 3.1 安全运维

**S-08**
> 作为酒店安全负责人，
> 我希望实时掌握门锁系统的安全态势，快速识别异常事件并做出响应，
> 以便保障酒店安全运营

**功能点说明：**

**1. 入口与布局**
- 在左侧栏，新增智能看板模块，点击智能看板模块，"安全运维智能体"作为第三个智能仪表盘；
- 页面顶部显示仪表盘名称、最后时间、刷新按钮；整体布局分为统计卡片、图表模块、AI洞察三个区域。

**2. 统计卡片（五个指标）**
- （1）**系统健康评分**：综合评分（满分100），副指标显示较昨日变化和影响因素；
- （2）**异常事件（今日）**：异常事件总数，副指标显示安全/设备事件分布；
- （3）**离线设备**：当前离线设备数，副指标显示超4小时的紧急设备数；
- （4）**低电量预警**：低电量设备数，副指标显示电量<10%需立即更换的数量；
- （5）**网关在线率**：网关在线百分比，副指标显示在线/总数。

**3. 实时事件流**
- （1）按照时间倒序排列，最新事件在最上方，以时间轴列表呈现；
- （2）每条事件包含：时间戳、事件类型标签（安全/设备）、事件描述、房间号；
- （3）事件紧急程度标记（红黄蓝）；
- （4）支持Tab切换筛选：全部 / 安全事件 / 设备事件；
- （5）安全事件包括：飞房开门、连续鉴权失败、门未关超时、敏感卡使用等；
- （6）设备事件包括：网关离线、低电量报警等。

**4. 问题设备**
- （1）展示当前需要关注的问题设备列表；
- （2）支持Tab切换：离线设备 / 低电量设备；
- （3）每个设备项包含：房间号（彩色徽章）、问题标题、详细信息、状态标签；
- （4）离线设备显示：离线时长、是否与告警关联；
- （5）低电量设备显示：当前电量、预计耗尽时间。

**5. AI智能洞察**
- （1）AI根据仪表盘数据，生成安全相关洞察；
- （2）洞察内容侧重风险预警、异常模式识别、区域聚集分析。

**6. 数据更新**
- （1）自动刷新频率：1分钟；
- （2）静默刷新，数据变化时数字平滑更新；
- （3）右上角显示更新时间（HH:mm:ss）；
- （4）支持用户手动点击刷新按钮立即刷新。

### 3.2 前厅运营

**S-09**
> 作为店长/前台，
> 我希望快速了解门店房态和经营状况，掌握今日入退房情况，
> 以便做出数据驱动的决策和高效安排前台服务工作

**功能点说明：**

**1. 入口与布局**
- 前厅运营看板作为第二个仪表盘，顶部显示仪表盘名称"前厅运营智能体"、最后更新时间、刷新按钮；
- 整体布局：统计卡片区（顶部 5 个）→ 模块区（第一行 3 列 + 第二行 2 列）→ AI 洞察区（底部）。

**2. 统计卡片（5个指标）**
- （1）**当前入住率**：在住房间数/可用房间总数×100%，副指标显示较昨日升降趋势 + 在住/总房数；
- （2）**今日入住**：当日新发卡入住的房间数，副指标显示执行进度（如"待办 18 · 已办 24"）；
- （3）**今日退房**：当日房卡到期的房间数，副指标显示执行进度（如"待退 15 · 已退 23"）；
- （4）**异常关注**：需要关注的异常事项数量（红色高亮），副指标显示异常类型提示；
- （5）**平均入住时长**：当前在住房间的平均住店天数（保留1位小数），副指标显示较昨日变化趋势。

**3. 今日房态模块（第一行左侧）**
- （1）展示今日入退房的房间列表，支持 Tab 切换；
- （2）Tab 切换：
  - “今日退房”：房卡今日到期的房间；
  - “今日入住”：今日发卡入住的房间；
- （3）列表内容：房间号（彩色徽章样式）、时间信息、入住信息、状态标签（在住/已退/已入住）。

**4. 入住时长分布（第一行中间）**
- （1）以4条横向进度条显示各时长区间的房间占比；
- （2）当日房（≤1天，绿色）、短住（2-3天，金色）、中住（4-7天，蓝色）、长住（>7天，紫色）；
- （3）每条进度条显示房间数、占比百分比；
- （4）顶部显示总在住房间数（如"共 124 间在住"）。

**5. 房型入住统计（第一行右侧）**
- （1）以4条横向进度条显示各房型的入住率；
- （2）房型分类：大床房、双床房、套房、其他；
- （3）每条进度条显示房型名称、入住数/总房量、入住率百分比；
- （4）不同房型使用不同颜色进度条；
- （5）顶部显示总房量（如"总房量 156 间"）。

**6. 入住率趋势图（第二行左侧）**
- （1）折线图形式，展示近7天入住率变化；
- （2）横轴表示日期+星期，纵轴表示入住率百分比；
- （3）鼠标悬停显示具体入住率和房间数；
- （4）入住率 ≥ 90% 的数据点显示高峰标记；
- （5）当进入此仪表盘时，折线会有绘制动画效果。

**7. 本周入住高峰热力图（第二行右侧）**
- （1）以热力图展示，时段×星期的矩阵；
- （2）横轴表示时段（06:00-22:00），纵轴表示星期；
- （3）使用颜色深浅表示该时段入住数量，颜色越深数量越多；
- （4）鼠标悬停显示具体入住间数（例如"周五 14:00 - 18间"）。

**8. AI 前厅运营洞察**
- （1）AI 根据仪表盘数据，生成运营与服务相关洞察；
- （2）洞察内容融合服务提醒和运营建议：
  - 异常跟进提醒（如"0305、0402 房间超时未退房，建议确认续住或退房意向"）；
  - 入住高峰提醒（如"今日入住高峰预计在 17:00-19:00，建议前台增加人手"）；
  - 房型平衡建议（如"双床房入住率达 84%，建议优先推荐大床房平衡房态"）；
- （4）点击"深入了解"可打开 AI 助手继续对话。

**9. 数据更新**
- （1）自动刷新频率：1分钟；
- （2）静默刷新，数据变化时数字平滑更新；
- （3）右上角显示更新时间（HH:mm:ss）；
- （4）支持用户手动点击刷新按钮立即刷新。

**10. 数据边界说明**
- （1）所有数据均来自门锁系统发卡记录和房间信息；
- （2）在住 = 房间有有效房卡（未过期），退房 = 房卡已到期；
- （3）不显示客人姓名、预订信息等门锁系统边界外的数据。

### 3.3 设备运维（本版本已合并）

说明：在 v1.1 的 UI 原型中，不提供独立的“设备运维”仪表盘。设备相关能力已合并到“3.1 安全运维”中统一呈现，包括：网关在线率、离线设备、低电量预警、设备类事件流等。

本章节保留为后续版本规划，不纳入本版本验收范围。

### 3.4 看板导出（PDF）
> 作为门锁系统管理用户，
> 我希望在智能看板页面快速导出当前看板视图形成可分享的“报告”，
> 以便用于交接与复盘。

**功能点说明：**

**1. 入口与范围**
- （1）在三张智能看板页面（数据总览/前厅运营/安全运维）提供“导出 PDF”入口；
- （2）导出内容为“当前看板页面的可视化视图与关键模块内容”（用于汇报/交接），不提供原始明细数据导出。

**2. 与报表的关系（边界）**
- （1）导出 PDF 不替代门锁系统既有“报表”能力；数据查询与明细导出仍以报表模块为主。

**3. 导出结果**
- （1）导出结果为单个 PDF 文件，便于留档、发送与打印。

---

## 四、知识库

### 4.1 知识库内容

**S-11**
> 作为酒店用户，
> 我希望在AI对话涉及知识库的分支时，能够得到有据可查的回答，
> 以便确保回复准确。

**功能点说明：**

**1. 检索触发**
- （1）当用户提问被意图识别为FAQ/SOP时，自动触发知识库检索；
- （2）用户无需知道知识库的存在，检索过程完全后台进行。

**2. 检索策略**
- （1）根据用户问题构造检索查询向量；
- （2）在向量库中按相似度检索，同时在全文索引中做关键词召回，合并去重；
- （3）按相似度进行重排序，取最相关的结果。

**3. 引用标注格式**
- （1）在回答末尾列出引用来源：文档标题、章节；
- （2）正文中使用编号标注（如【1】）与引用列表对应。

**4. 无命中处理**
- （1）当检索结果相关性不足时，返回"未检索到相关信息"提示；
- （2）同时提供改写建议或引导用户换个方式描述；
- （3）不生成无依据的回答。

---

## 五、安全及可靠性

### 5.1 异常备案

**S-12**
> 作为用户，
> 我希望在AI助手无法正常响应时，获得清晰的提示和下一步建议，而非卡住或输出错误答案，
> 以便提升用户体验

**功能点说明：**

**1. 无命中与澄清**
- （1）当RAG或意图识别无可靠结果时，必须返回明确无命中提示；
- （2）AI生成2-3条改写建议或澄清问题。

**2. 超时处理**
- 若AI响应超时（3秒），将转为后台执行。同时告知用户任务正在执行，稍后再查看。

**3. 部分结果提示说明**
- （1）若数据部分不可用，则标记部分结果和提示用户；
- （2）若数据缺失，输出提示"数据不完整，建议稍后再试"。

**4. 重试机制**
- 允许用户点击重试按钮，再次输入当前提示词给AI，重新处理本轮对话。

### 5.2 日志与数据脱敏

**S-13**
> 作为IT用户，
> 我需要追溯关键操作与问答行为，知道谁在什么时候对哪些数据做了什么，同时确保在日志和回答中不会泄漏住客隐私，
> 以便符合审计和安全要求

**功能点说明：**

**1. 日志范围**
- 登录/登出、知识库文档上传/发布/回滚、报表导出、通过MCP或其他接口发起数据查询异常。

**2. 日志基础信息**
- 时间戳、操作者、操作类型、操作对象、结果。

**3. 数据脱敏**
- （1）**敏感数据范围**：
  - 个人信息：客户姓名、手机号、邮箱、证件号、房卡卡号、订单号等；
  - 业务敏感信息：例如门锁设备密钥。
- （2）数据查询时，涉及敏感字段默认不返回，仅明确功能且经过脱敏处理才能返回（如手机号：138****5678）；
- （3）AI在查询数据场景下，需对生成内容进行敏感检测，命中时替换掩码或提示语。日志和监控数据中禁止写入原始敏感信息。

**4. 日志存储**
- 日志存储在系统后端日志，前台不显示。

### 5.3 输出控制

**S-14**
> 作为用户，
> 我希望在AI助手输入输出有模型监控，
> 以便结果符合数据隐私安全要求

**功能点说明：**

**1. 输入防护层**
- 在生成层调用AI模型生成内容前，增加一层安全防护层，过滤传入信息中的敏感信息。

**2. 输出防护层**
- 同样，在模型生成内容后，加一层安全防护层，拦截输出中的敏感信息。

**3. 检测维度**
- （1）内容合规（黄赌毒暴力……）；
- （2）用户是否存在恶意注入攻击提示词；
- （3）数据隐私（手机号码之类）；
- （4）幻觉与一致性。

**4. 拦截阻断**
- 当发现违规信息时，直接拦截输出，返回错误提示"检测到不当内容，已停止生成"；
- 并将拦截行为在日志中标记。

**5. 本地部署方案**
- 若系统本地部署，采用轻量级分类模型（如Gemma3 270M微调）或关键词等实现拦截层效果（具体待开发过程中调试而定），以确保低延迟。

**验收标准：**
- 恶意注入拦截
- 敏感数据拦截
- 响应延迟

---

## 六、数据接入与集成

### 6.1 MCP接口查询支持

**S-15**
> 作为用户，
> 我希望使用AI助手查询数据或生成报表时，希望它调用门锁系统真实的数据和报表能力（通过 MCP 工具实现），
> 以便结果与现有系统保持一致并提高工作效率

**功能点说明：**

**1. 协议兼容**
- （1）支持MCP最新版本并向下兼容，按协议注册资源与工具名称；
- （2）实现必要的特征描述，使agent能够识别发现可用工具。

**2. 查询模型**
- （1）提供事件、设备、告警等核心查询工具（基于门锁系统已有查询能力封装）；
- （2）工具命名清晰，例如 `events.query`。参数结构与门锁数据接口保持一致。

**3. 数据路径一致**
- （1）MCP返回的数据与API、报表接口使用相同的数据定义和业务规则；
- （2）参数格式尽量与智能报表对齐，降低集成成本。

**4. 安全与限流**
- （1）MCP请求验证身份凭证，复用门锁系统已有账号体系；
- （2）对MCP通道单独设置速率限制，防止被滥用；
- （3）记录所有MCP调用日志，包含调用方、工具名、参数摘要、结果状态等。

**5. 返回格式与文档**
- （1）查询结果以结构化JSON返回，每个字段提供类型定义和简要说明；
- （2）预提供完整的工具描述文档（schema、参数说明、示例），便于外部集成。

**6. 备注**
- （1）可基于现有数据库接口封装MCP适配层，避免重复开发查询逻辑；
- （2）协议版本兼容由技术维护。

### 6.2 查询场景MCP定义

以下是AI助手可调用的MCP工具列表：

| 序号 | 名称 | 英文 | 用途 |
|------|------|------|------|
| 1 | 查询房间入住状态 | get_room_occupancy_status | 查询房间当前的入住状态，用于当房卡无效时AI判断是否客人已退房 |
| 2 | 查询门卡有效性 | get_card_validity_info | 检测房卡的有效性，判断房卡是否过期/挂失/被终止，用于AI判断开门失败的原因 |
| 3 | 查询设备状态 | get_device_status | 查询门锁设备的在线状态、电量、网络连接，用于AI判断设备故障 |
| 4 | 查询近期开门记录 | get_recent_lock_events | 查询门锁近期的开门记录和异常事件，用于AI分析故障原因和异常模式 |
| 5 | 一键健康巡检 | get_system_check_summary | 快速扫描酒店所有门锁/网关的异常状态，用于AI生成巡检报告 |
| 6 | 翻译事件错误码 | get_error_code_explanation | 将设备事件编码翻译成业务语义说明，用于AI生成用户友好的错误解释 |
| 7 | 多条件搜索房间 | search_rooms_by_criteria | 多条件搜索房间，用于AI回答比如"哪个房间正在清洁"、"哪个楼层空房"等查询 |
| 8 | 查询公区门禁权限 | get_area_access_permissions | 查询卡片的公共区域门禁访问权限，用于AI判断刷卡失败的原因 |
| 9 | 查询亲属房/加房列表 | get_extended_rooms_list | 查询宾客卡可开的亲属房/加房列表，用于AI回答为什么开不了房间的问题 |
| 10 | 查询管理员审计日志 | get_operator_audit_log | 查询管理员的权限变更和操作记录，用于合规审计和AI生成报告 |
| 11 | 统计发卡使用情况 | get_card_usage_statistics | 统计卡片使用情况（发卡/退卡/补卡数量），用于AI回答房卡数量相关问题 |
| 12 | 查询员工信息与权限 | get_employee_info | 查询员工信息和权限，用于AI回答员工权限相关问题 |
| 13 | 查询网关健康状态 | get_gateway_health_status | 查询网关设备的在线状态和负载，用于AI诊断门锁是否批量离线问题 |
| 14 | 查询zigbee任务状态 | get_zigbee_task_status | 查询下发给门锁的任务执行状态，用于AI诊断制卡后门锁没反应的问题 |

---

#### 6.2.1 查询房间入住状态 (get_room_occupancy_status)

**输入参数：**
- 房间名称

**输出字段：**
1. 房间名称
2. 房间状态：干净、在住、维修中、脏房、已预订
3. 实际入住时间
4. 计划退房时间
5. 是否超时续住
6. 当前宾客姓名
7. 关联账单号

**示例：**
- 用户："2101房间现在有人住吗？"
  AI：调用工具 → "2101房间当前状态为在住，客人张先生于11月20日入住，计划11月23日退房。"
- 用户："为什么305客人的卡刷不开？"
  AI：调用工具 → "305房间客人已于今天上午10:00退房，但卡片刷卡时间是10:05，卡片已过期。建议前台确认客人是否需要延住。"

---

#### 6.2.2 查询门卡有效性 (get_card_validity_info)

**输入参数：**
- 卡代号

**输出字段：**
1. 卡代号
2. 卡类型
3. 房卡是否有效
4. 有效期开始时间
5. 有效期结束时间
6. 是否已过期
7. 是否已挂失
8. 是否已终止/被顶替
9. 关联房间名称
10. 持卡人姓名

**示例：**
- 用户："这张卡号XXXX为什么不能用了？"
  AI：调用工具 → "该卡片已于11月20日12:00过期。这是一张宾客卡，关联房间为2101。建议客人到前台补办新卡。"
- 用户："查下卡号XXX的状态。"
  AI：调用工具 → "该卡片已被客人挂失，挂失时间为11月19日15:30。卡片已失效，无法再次使用。"

---

#### 6.2.3 查询设备状态 (get_device_status)

**输入参数：**
- 房间名称

**输出字段：**
1. 房间名称
2. 门锁编号
3. 设备状态：在线正常、完全离线、Zigbee网络离线、低电量报警
4. 电池电量百分比
5. 信号强度
6. 最后活跃时间
7. 固件版本号

**示例：**
- 用户："4楼所有房间的门锁状态正常吗？"
  AI：调用工具 → "4楼共有20个房间，其中402和415两个房间的门锁显示低电量报警，建议安排IT更换电池。其余房间门锁正常。"
- 用户："2101的门锁为什么离线？"
  AI：调用工具 → "2101门锁最后活跃时间为今天8:15，当前Zigbee网络离线。信号强度显示较弱。建议检查楼层网关是否正常工作。"

---

#### 6.2.4 查询近期开门记录 (get_recent_lock_events)

**输入参数：**
1. 房间名称
2. 事件数量
3. 事件类型选择：访问、错误、状态

**输出字段：**
1. 房间名称
2. 事件列表数组，每个事件包含：
   - 事件发生时间
   - 事件类型
   - 开门方式
   - 事件描述
   - 事件编码
   - 触发事件的卡号
   - 操作是否成功

**示例：**
- 用户："301房间今天有人进去过吗？"
  AI：调用工具 → "301房间今天有3次成功开门记录：08:05宾客卡开门、12:30保洁卡开门、18:20宾客卡开门。"
- 用户："505房间为什么一直报警？"
  AI：调用工具 → "505房间最近10分钟内检测到5次无效卡刷卡失败记录，以及2次机械钥匙强制开门事件，建议立即派保安人员前往查看。"

---

#### 6.2.5 一键健康巡检 (get_system_check_summary)

**输入参数：**
1. 检查范围：全部、仅设备状态、仅卡片有效、仅网络联通
2. 指定区域（楼栋、楼层）

**输出字段：**
1. 检查执行时间
2. 检查总房间数
3. 设备问题统计对象：离线设备数量、低电量设备数量、Zigbee离线数量、受影响的房间名称列表
4. 卡片问题统计对象：过期卡片数量、挂失卡片数量
5. 网络问题统计对象：离线网关数量、网关详情列表（网关名称、状态、最后活跃时间）
6. 健康度分数

**示例：**
- 用户："帮我检查一下整个酒店的门锁系统。"
  AI：调用工具 → "系统健康检查完成（检查时间14:30）。全酒店共150间客房，发现以下问题：①3个房间门锁离线（201、305、412）②8个房间门锁低电量（需尽快更换电池）③1个网关离线（3楼西侧网关）。系统健康评分：82分。建议优先处理离线网关问题。"
- 用户："今天早班巡检报告。"
  AI：调用工具 → 生成完整巡检报告，包含异常门锁清单和处理建议。

---

#### 6.2.6 翻译事件错误码 (get_error_code_explanation)

**输入参数：**
- 事件方式编码
- 事件结果编码
- 语言

**输出字段：**
1. 事件方式名称
2. 事件名称
3. 事件类型：访问、错误、状态
4. 严重程度：正常、警告、错误
5. 建议操作文字描述

**示例：**
- 用户："事件代码130-11是什么意思？"
  AI：调用工具 → "这表示宾客卡刷卡失败，卡片已失效。建议客人到前台重新办理门卡。"
- 用户："门锁日志里显示event_code=5，这是啥？"
  AI：调用工具 → "事件码5表示门锁电量低报警。建议IT安排更换电池，避免影响客人使用。"

---

#### 6.2.7 多条件搜索房间 (search_rooms_by_criteria)

**输入参数：**
1. 楼栋
2. 楼层
3. 房间状态：干净、在住、维修中、脏房
4. 房型
5. 最多返回结果数，默认20

**输出字段：**
1. 符合条件的总数
2. 房间列表：房间名称、楼栋编码、楼层编号、房型名称、房间状态、是否在住、设备状态（在线、离线、低电量）

**示例：**
- 用户："4楼现在有哪些空房？"
  AI：调用工具 → "4楼目前有5间空净房可入住：401、403、408、412、415。其中401和408是标准间，其余为大床房。"
- 用户："现在有哪些房间在维修？"
  AI：调用工具 → "全酒店共有3个房间处于维修状态：201（空调故障）、305（门锁更换）、512（卫生间漏水）。"

---

#### 6.2.8 查询公区门禁权限 (get_area_access_permissions)

**输入参数：**
- 卡代号

**输出字段：**
1. 卡代号
2. 是否配置区域权限
3. 可访问区域列表：区域编码、区域名称、可访问时间段
4. 受限区域列表
5. 区域权限配置时间

**示例：**
- 用户："房卡为什么刷不开健身房？"
  AI：调用工具 → "房卡（XXX）仅配置了客房权限，未开通公区门禁。健身房、泳池等公共区域，需要前台开通权限或领取专用卡。"
- 用户："这张员工卡能开哪些区域？"
  AI：调用工具 → "该员工卡可访问以下区域：员工通道、洗衣房、仓库A、办公区。访问时间限制为每天06:00-22:00。"

---

#### 6.2.9 查询亲属房/加房列表 (get_extended_rooms_list)

**输入参数：**
- 卡代号
- 账单编号

**输出字段：**
1. 主房间名称
2. 账单编号
3. 宾客姓名
4. 是否配置了亲属房/加房
5. 扩展房间列表：房间名称、房间类型、关联类型、门锁编号、当前卡是否可开
6. 系统配置说明：是否允许宾客卡开亲属房

**示例：**
- 用户："这张卡能开2102房间吗？我们定了两间房。"
  AI：调用工具 → "这张卡关联主房间为2101，系统已配置亲属房2102。可以同时开启这两个房间。"
- 用户："为什么这张卡开不了隔壁房？"
  AI：调用工具 → "宾客的账单仅关联2101一间房间，未配置亲属房。如需访问其他房间，请联系前台添加房间关联或领取额外门卡。"

---

#### 6.2.10 查询管理员审计日志 (get_operator_audit_log)

**输入参数：**
- 员工ID
- 查询开始日期
- 查询结束日期
- 操作类型过滤
- 最多返回结果数，默认50

**输出字段：**
1. 符合条件的总记录数
2. 审计记录列表：记录ID、员工ID、员工姓名、职位名称、操作时间、操作类型、操作功能名称、受影响的资源、备注说明

**示例：**
- 用户："查一下张三今天做了哪些操作？"
  AI：调用工具 → "员工张三（前台）今日共执行14次操作：办理入住5次、制作宾客卡8次、退房结账1次。最近操作时间为15:30（为501房间制卡）。"
- 用户："谁在昨天修改了房价？"
  AI：调用工具 → "11月20日共有2名员工修改过房价：经理李四（10:15修改了豪华套房价格）、主管王五（14:30调整了标间折扣）。"

---

#### 6.2.11 统计发卡使用情况 (get_card_usage_statistics)

**输入参数：**
- 统计开始日期
- 统计结束日期
- 卡类型过滤
- 楼栋筛选

**输出字段：**
1. 统计时间段：开始时间、结束时间
2. 发卡统计：总发卡数、宾客卡数量、员工卡数量、特殊卡数量
3. 退卡统计：总退卡数、正常退房退卡数、挂失退卡数
4. 补卡统计：总补卡数、因遗失补卡数、因损坏补卡数
5. 当前有效卡片总数

**示例：**
- 用户："今日一共发了多少张卡？"
  AI：调用工具 → "今天（截止14:30）共发卡78张，其中宾客卡72张、员工卡3张、应急卡3张。退卡35张（含正常退房32张、挂失退卡3张）。"
- 用户："这个月补卡情况统计。"
  AI：调用工具 → "本月共补卡45张，其中因遗失补卡28张、因损坏补卡17张。建议加强客人保管卡片的提示。"

---

#### 6.2.12 查询员工信息与权限 (get_employee_info)

**输入参数：**
- 员工ID
- 员工姓名

**输出字段：**
1. 员工ID
2. 员工姓名
3. 是否操作员
4. 职位名称
5. 权限列表：功能名称、功能类别
6. 账号是否激活
7. 最后登录时间
8. 备注说明

**示例：**
- 用户："谁有权限修改房价？"
  AI：调用工具 → "目前有3名员工拥有修改房价的权限：经理李四、主管王五、财务赵六。其中李四拥有所有房型的修改权限。"
- 用户："查一下张三的权限。"
  AI：调用工具 → "员工张三（前台接待）拥有以下权限：办理入住、制作宾客卡、退房结账、查询账单。最后登录时间为今天08:05。"

---

#### 6.2.13 查询网关健康状态 (get_gateway_health_status)

**输入参数：**
- 网关地址
- 楼栋筛选

**输出字段：**
1. 网关地址
2. 网关名称
3. 在线状态
4. 最后时间
5. 挂载子设备数量
6. 网络信号质量
7. 固件版本
8. 客户端ID

**示例：**
- 用户："检查一下8楼的网关状态。"
  AI：调用工具 → "8楼共有2个网关。网关GW-801（MAC: AA:BB:CC:01）在线正常，挂载25个门锁，信号质量良好；网关GW-802（MAC: AA:BB:CC:02）离线，最后心跳时间为今天03:15，建议工程部检查网络连接。"
- 用户："为什么8楼所有房间的锁都显示离线？"
  AI：调用工具 → "问题已定位：负责8楼的网关GW-801已离线2小时，导致该楼层25间客房门锁失联。请立即检查网关电源和网络连接，或联系技术支持更换设备。"

---

#### 6.2.14 查询zigbee任务状态 (get_zigbee_task_status)

**输入参数：**
- 房间名称
- 任务类型

**输出字段：**
1. 房间名称
2. 待执行任务列表
3. 最后成功的任务信息：任务类型、完成时间
4. 门锁在线状态

**示例：**
- 用户："刚给2101制了卡，但客人说刷不开门。"
  AI：调用工具 → "检测到问题：2101的制卡任务已发送给门锁，但未收到确认（状态：已发送，重试2次）。门锁在线状态正常。可能原因：①门锁忙碌中 ②Zigbee信号干扰。建议：等待30秒后重新制卡，或使用手持机近距离制卡。"
- 用户："2101的退房指令发下去了吗？"
  AI：调用工具 → "退房指令已成功执行，完成时间为今天14:08。门锁已清空该房间的所有卡片权限，最后一次成功任务为'退房清除授权'。"
- 用户："3202的门锁为什么一直收不到指令？"
  AI：调用工具 → "问题定位：3202的门锁当前离线，有3条待发送任务积压（制卡、修改配置、时间同步），最早的任务创建于2小时前。请工程部检查：①门锁电池是否耗尽 ②Zigbee网关是否正常 ③门锁是否被物理拆卸。"

